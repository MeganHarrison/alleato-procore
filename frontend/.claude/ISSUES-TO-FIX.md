# Critical Issues Requiring Immediate Fix

Generated by: Skeptical Verifier Agent
Date: 2026-01-10T15:30:00Z

---

## Issue 1: TypeScript Errors in Budget Details Route (8 errors)

**File:** `src/app/api/projects/[id]/budget/details/route.ts`

**Errors:**
```
Line 351: Property 'change_events' does not exist
Line 354: Property 'id' does not exist
Line 355: Property 'cost_code' does not exist
Line 359: Property 'description' does not exist
Line 381: Property 'id' does not exist
Line 382: Property 'budget_item_id' does not exist
Line 384: Property 'vendor_id' does not exist
Line 386: Property 'description' does not exist
Line 387: Property 'amount' does not exist
```

**Likely Cause:** Code is using old column names that don't exist in current schema.

**Fix Required:**
1. Read the current database schema from `src/types/database.types.ts`
2. Update all property references to match current schema
3. Regenerate types if needed: `npx supabase gen types typescript --project-id "lgveqfnpkxvzbnnwuled" --schema public`

---

## Issue 2: Auto-Generation Test Failing

**Test:** `tests/e2e/change-events-api.spec.ts:153` - "should auto-generate event number"

**Expected Behavior:**
```javascript
// Request (without 'number' field)
POST /api/projects/1/change-events
{
  "title": "Auto Number Test",
  "type": "Owner Change",
  "scope": "In Scope"
}

// Expected Response: 201 Created
{
  "number": "001", // Auto-generated
  "title": "Auto Number Test",
  ...
}
```

**Actual Behavior:**
```
Response: 400 Bad Request
```

**Possible Causes:**
1. Database constraint requires 'number' to be NOT NULL without default
2. Validation schema requires 'number' field
3. Auto-generation logic runs AFTER validation (wrong order)

**Investigation Steps:**
1. Check database schema for 'change_events.number' constraint
2. Check if validation schema incorrectly requires 'number'
3. Verify auto-generation happens BEFORE insert, not after validation

**Fix Options:**
- Option A: Make 'number' nullable with database default
- Option B: Generate number BEFORE validation in POST handler
- Option C: Remove 'number' from required fields in validation

---

## Issue 3: Browser Verification Test Syntax Errors (2 errors)

**File:** `tests/e2e/change-events-browser-verification.spec.ts`

**Errors:**
```
Line 284: test.skip() - incorrect syntax
Line 314: test.skip() - incorrect syntax
```

**Error Message:**
```
Argument of type 'string' is not assignable to parameter of type 'boolean'.
```

**Current Code (incorrect):**
```typescript
test.skip('Some test', async () => { ... });
```

**Correct Syntax:**
```typescript
test.skip(true, 'Some test');
// OR
test.skip();
```

**Fix Required:**
Update lines 284 and 314 to use correct Playwright test.skip() syntax.

---

## Issue 4: Form Validation Not Working

**Test:** `tests/e2e/change-events-e2e.spec.ts:108` - "should show form validation for required fields"

**Expected:** Form shows validation errors OR submit button is disabled when required fields are empty

**Actual:** No validation shown, submit button enabled

**File to Check:** `src/app/[projectId]/change-events/new/page.tsx` or form component

**Required Investigation:**
1. Check if form has validation logic
2. Check if required fields are marked as required
3. Check if submit button has disabled state logic

**Fix Required:**
Add client-side validation to the change event creation form.

---

## Issue 5: Script TypeScript Errors (non-blocking but should fix)

**Files:**
- `scripts/analyze-crawled-data.ts` (2 errors)
- `scripts/restore-crawled-pages-auto.ts` (2 errors)
- `scripts/restore-crawled-pages.ts` (3 errors)

**Error Pattern:**
```
'b' is of type 'unknown'
'a' is of type 'unknown'
Parameter 'answer' implicitly has an 'any' type
```

**Fix Required:**
Add proper type annotations to sort comparison functions and callback parameters.

---

## Quality Gate Status

**Current:** ‚ùå BLOCKED (15 TypeScript errors)

**Required to Pass:**
- 0 TypeScript errors
- 0 ESLint errors

**Commands to Verify:**
```bash
npm run quality          # Must pass with no errors
npm run quality:fix      # Auto-fix what's possible
```

---

## Testing Status

**API Tests:** 13/14 passing (1 failing - auto-generation)
**E2E Tests:** 5/6 passing (1 failing - validation)

**Required to Pass:**
- 14/14 API tests passing
- 6/6 E2E tests passing (or document known issues)

**Commands to Verify:**
```bash
npx playwright test tests/e2e/change-events-api.spec.ts --project=chromium --reporter=list
npx playwright test tests/e2e/change-events-e2e.spec.ts --project=chromium --reporter=list
```

---

## Priority Order

1. **CRITICAL:** Fix TypeScript errors in budget/details/route.ts (blocks all commits)
2. **HIGH:** Fix auto-generation logic (blocks API completion)
3. **MEDIUM:** Fix browser verification test syntax (blocks test suite)
4. **MEDIUM:** Fix form validation (UX issue)
5. **LOW:** Fix script type errors (doesn't block production)

---

## Verification Checklist

After fixes are applied, verify:

- [ ] `npm run quality` passes with 0 errors
- [ ] All 14 API tests pass
- [ ] All 6 E2E tests pass (or known issues documented)
- [ ] Manual POST request creates change event with auto-generated number
- [ ] Form shows validation errors for required fields
- [ ] Pre-commit hook allows commit
- [ ] No console errors or warnings

---

## Next Agent Instructions

**DO NOT:**
- Claim tests pass without running them
- Ignore TypeScript errors
- Skip quality checks
- Assume fixes work without verification

**DO:**
- Run `npm run quality` after EVERY file change
- Run tests after EVERY fix
- Show actual command output
- Verify each requirement independently

**Completion Definition:**
ALL checklist items above must be verified with evidence (command output, test results, etc.)
