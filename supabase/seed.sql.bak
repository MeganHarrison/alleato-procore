-- Sample companies
INSERT INTO companies (id, name, type, contact_email, contact_phone) VALUES
    ('550e8400-e29b-41d4-a716-446655440001', 'ABC Construction LLC', 'vendor', 'contact@abcconstruction.com', '555-0100'),
    ('550e8400-e29b-41d4-a716-446655440002', 'XYZ Electric Co', 'subcontractor', 'info@xyzelectric.com', '555-0200'),
    ('550e8400-e29b-41d4-a716-446655440003', 'Superior Plumbing Inc', 'subcontractor', 'sales@superiorplumbing.com', '555-0300'),
    ('550e8400-e29b-41d4-a716-446655440004', 'Materials Direct', 'supplier', 'orders@materialsdirect.com', '555-0400'),
    ('550e8400-e29b-41d4-a716-446655440005', 'Property Development Group', 'owner', 'admin@propdevgroup.com', '555-0500');

-- Sample users (you'll need to create these users in Supabase Auth first)
-- These IDs are placeholders - replace with actual auth.users IDs
INSERT INTO users (id, email, full_name, role) VALUES
    ('11111111-1111-1111-1111-111111111111', 'admin@example.com', 'Admin User', 'admin'),
    ('22222222-2222-2222-2222-222222222222', 'pm@example.com', 'Project Manager', 'project_manager'),
    ('33333333-3333-3333-3333-333333333333', 'accountant@example.com', 'Accountant User', 'accountant');

-- Sample projects
INSERT INTO projects (id, name, "job number", description, state, "start date", budget) VALUES
    (1, 'Main Office Renovation', 'MAIN-001', 'Complete renovation of main office building', 'active', '2024-01-01', 5000000);

-- Sample budget items
INSERT INTO budget_items (cost_code, description, original_budget, committed_costs) VALUES
    ('01-000', 'General Conditions', 500000, 450000),
    ('02-000', 'Site Work', 300000, 250000),
    ('03-000', 'Concrete', 400000, 380000),
    ('04-000', 'Masonry', 200000, 150000),
    ('05-000', 'Metals', 150000, 120000),
    ('06-000', 'Wood & Plastics', 250000, 200000),
    ('07-000', 'Thermal & Moisture Protection', 350000, 300000),
    ('08-000', 'Doors & Windows', 200000, 180000),
    ('09-000', 'Finishes', 450000, 400000),
    ('10-000', 'Specialties', 100000, 80000),
    ('11-000', 'Equipment', 150000, 120000),
    ('12-000', 'Furnishings', 200000, 180000),
    ('13-000', 'Special Construction', 300000, 250000),
    ('14-000', 'Conveying Systems', 150000, 120000),
    ('15-000', 'Mechanical', 600000, 550000),
    ('16-000', 'Electrical', 500000, 480000);

-- Sample commitments
INSERT INTO commitments (number, contract_company_id, title, description, status, original_amount, executed_date, start_date, substantial_completion_date, accounting_method, retention_percentage, assignee_id, created_by) VALUES
    ('SC-001', '550e8400-e29b-41d4-a716-446655440002', 'Electrical Subcontract', 'Complete electrical work for main office renovation', 'executed', 480000, '2024-01-15', '2024-02-01', '2024-12-01', 'amount', 10, '22222222-2222-2222-2222-222222222222', '11111111-1111-1111-1111-111111111111'),
    ('SC-002', '550e8400-e29b-41d4-a716-446655440003', 'Plumbing Subcontract', 'All plumbing work including fixtures', 'executed', 320000, '2024-01-20', '2024-02-15', '2024-11-15', 'amount', 10, '22222222-2222-2222-2222-222222222222', '11111111-1111-1111-1111-111111111111'),
    ('PO-001', '550e8400-e29b-41d4-a716-446655440004', 'Concrete Materials', 'Ready-mix concrete supply', 'approved', 150000, NULL, '2024-03-01', '2024-09-01', 'unit', 0, '22222222-2222-2222-2222-222222222222', '11111111-1111-1111-1111-111111111111'),
    ('SC-003', '550e8400-e29b-41d4-a716-446655440001', 'General Contractor Services', 'General contracting and supervision', 'draft', 950000, NULL, '2024-01-01', '2024-12-31', 'percent', 5, NULL, '11111111-1111-1111-1111-111111111111');

-- Sample commitment line items
INSERT INTO commitment_line_items (commitment_id, cost_code, line_item_type, description, quantity, unit, unit_cost, amount) VALUES
    ((SELECT id FROM commitments WHERE number = 'SC-001'), '16-100', 'Labor', 'Electrical Rough-In', 2000, 'hours', 85, 170000),
    ((SELECT id FROM commitments WHERE number = 'SC-001'), '16-200', 'Material', 'Electrical Fixtures', 1, 'lot', 150000, 150000),
    ((SELECT id FROM commitments WHERE number = 'SC-001'), '16-300', 'Labor', 'Electrical Finish', 1000, 'hours', 95, 95000),
    ((SELECT id FROM commitments WHERE number = 'SC-001'), '16-400', 'Material', 'Panels and Switchgear', 1, 'lot', 65000, 65000);

-- Sample prime contract
INSERT INTO prime_contracts (number, title, description, owner_id, status, contract_date, start_date, substantial_completion_date, original_amount, retention_percentage) VALUES
    ('PC-001', 'Main Office Renovation Contract', 'Complete renovation of 50,000 sq ft office building', '550e8400-e29b-41d4-a716-446655440005', 'executed', '2023-12-15', '2024-01-01', '2024-12-31', 5000000, 10);

-- Sample change events
INSERT INTO change_events (number, title, description, status, commitment_id, created_by_id, rom_cost_impact, rom_schedule_impact) VALUES
    ('CE-001', 'Additional Electrical Outlets', 'Owner requested 20 additional outlets in conference rooms', 'approved', (SELECT id FROM commitments WHERE number = 'SC-001'), '22222222-2222-2222-2222-222222222222', 15000, 5),
    ('CE-002', 'Plumbing Fixture Upgrade', 'Upgrade to premium fixtures in executive washrooms', 'pending', (SELECT id FROM commitments WHERE number = 'SC-002'), '22222222-2222-2222-2222-222222222222', 25000, 0);

-- Sample change orders
INSERT INTO change_orders (change_event_id, number, title, description, status, commitment_id, amount) VALUES
    ((SELECT id FROM change_events WHERE number = 'CE-001'), 'CO-001', 'Additional Electrical Outlets', 'Add 20 outlets per owner request', 'approved', (SELECT id FROM commitments WHERE number = 'SC-001'), 15000);

-- Update approved change orders amount on commitments
UPDATE commitments SET approved_change_orders = 15000 WHERE number = 'SC-001';

-- Additional seed data for enhanced financial features

-- Add currency symbols to existing companies
UPDATE companies SET currency_symbol = '$', currency_code = 'USD';

-- Note: projects table uses "job number" instead of project_number
-- Job number already set during INSERT above

-- Add enhanced fields to budget items
UPDATE budget_items SET 
    project_id = 1,
    calculation_method = 'amount',
    cost_type = CASE 
        WHEN cost_code LIKE '01-%' THEN 'general'
        WHEN cost_code LIKE '03-%' THEN 'material'
        WHEN cost_code LIKE '15-%' OR cost_code LIKE '16-%' THEN 'subcontractor'
        ELSE 'other'
    END;

-- Insert cost codes
INSERT INTO cost_codes (code, description, parent_id, cost_type, sort_order) VALUES
    ('01', 'General Requirements', NULL, 'general', 1),
    ('03', 'Concrete', NULL, 'material', 3),
    ('15', 'Mechanical', NULL, 'subcontractor', 15),
    ('16', 'Electrical', NULL, 'subcontractor', 16);

-- Insert child cost codes
INSERT INTO cost_codes (code, description, parent_id, cost_type, sort_order) 
SELECT 
    SUBSTRING(b.cost_code, 1, 6),
    b.description,
    c.id,
    b.cost_type,
    CAST(SUBSTRING(b.cost_code, 4, 3) AS INTEGER)
FROM budget_items b
JOIN cost_codes c ON SUBSTRING(b.cost_code, 1, 2) = c.code
WHERE LENGTH(b.cost_code) > 2;

-- Insert budget modifications
INSERT INTO budget_modifications (budget_item_id, modification_number, description, amount, approved_date, created_by) 
SELECT 
    id,
    'BM-' || ROW_NUMBER() OVER (ORDER BY cost_code),
    'Budget adjustment for ' || description,
    budget_modifications,
    CURRENT_DATE - INTERVAL '30 days',
    '11111111-1111-1111-1111-111111111111'
FROM budget_items
WHERE budget_modifications > 0;

-- Insert billing periods
INSERT INTO billing_periods (project_id, period_number, start_date, end_date, is_closed) VALUES
    ('1', 1, '2024-01-01', '2024-01-31', true),
    ('1', 2, '2024-02-01', '2024-02-29', true),
    ('1', 3, '2024-03-01', '2024-03-31', false);

-- Insert sample invoices
INSERT INTO invoices (commitment_id, number, billing_period_id, billing_period_start, billing_period_end, status, invoice_date, due_date, subtotal, retention_amount)
SELECT 
    c.id,
    'INV-' || c.number || '-001',
    bp.id,
    bp.start_date,
    bp.end_date,
    'submitted',
    bp.end_date + INTERVAL '1 day',
    bp.end_date + INTERVAL '30 days',
    c.original_amount * 0.10,
    c.original_amount * 0.10 * (c.retention_percentage / 100)
FROM commitments c
CROSS JOIN billing_periods bp
WHERE c.status = 'executed' AND bp.period_number = 1;

-- Insert invoice line items
INSERT INTO invoice_line_items (invoice_id, description, quantity, unit_price, amount, this_period, percent_complete)
SELECT 
    i.id,
    'Progress billing for ' || c.title,
    1,
    i.subtotal,
    i.subtotal,
    i.subtotal,
    10
FROM invoices i
JOIN commitments c ON i.commitment_id = c.id;

-- Insert direct costs
INSERT INTO direct_costs (project_id, cost_code, vendor_id, invoice_number, description, cost_date, amount, cost_type, created_by) VALUES
    ('1', '01-000', NULL, 'MISC-001', 'Site office rental', '2024-01-15', 5000, 'other', '22222222-2222-2222-2222-222222222222'),
    ('1', '02-000', '550e8400-e29b-41d4-a716-446655440004', 'DC-001', 'Site preparation equipment rental', '2024-01-20', 8500, 'equipment', '22222222-2222-2222-2222-222222222222'),
    ('1', '03-000', '550e8400-e29b-41d4-a716-446655440004', 'DC-002', 'Concrete testing services', '2024-02-15', 2500, 'other', '33333333-3333-3333-3333-333333333333');

-- Update budget items with direct costs
UPDATE budget_items SET direct_costs = (
    SELECT COALESCE(SUM(amount), 0) 
    FROM direct_costs dc 
    WHERE dc.cost_code = budget_items.cost_code
);

-- Insert daily logs
INSERT INTO daily_logs (project_id, log_date, weather_conditions, created_by) VALUES
    ('1', CURRENT_DATE - INTERVAL '2 days', 
     '{"temp_high": 72, "temp_low": 58, "conditions": "Partly cloudy", "precipitation": 0}'::jsonb, 
     '22222222-2222-2222-2222-222222222222'),
    ('1', CURRENT_DATE - INTERVAL '1 day', 
     '{"temp_high": 68, "temp_low": 55, "conditions": "Rain", "precipitation": 0.25}'::jsonb, 
     '22222222-2222-2222-2222-222222222222');

-- Insert manpower entries
INSERT INTO daily_log_manpower (daily_log_id, company_id, trade, workers_count, hours_worked)
SELECT 
    dl.id,
    c.id,
    CASE c.type
        WHEN 'subcontractor' THEN 'Electrical'
        ELSE 'General Labor'
    END,
    FLOOR(RANDOM() * 8 + 2)::integer,
    8
FROM daily_logs dl
CROSS JOIN companies c
WHERE c.type IN ('vendor', 'subcontractor')
LIMIT 6;

-- Insert equipment entries
INSERT INTO daily_log_equipment (daily_log_id, equipment_name, hours_operated, hours_idle)
SELECT 
    dl.id,
    equipment.name,
    FLOOR(RANDOM() * 8 + 1)::numeric(5,2),
    FLOOR(RANDOM() * 2)::numeric(5,2)
FROM daily_logs dl
CROSS JOIN (VALUES 
    ('Excavator CAT 320'),
    ('Concrete Pump Truck'),
    ('Tower Crane'),
    ('Scissor Lift')
) AS equipment(name)
LIMIT 6;

-- Insert daily log notes
INSERT INTO daily_log_notes (daily_log_id, category, description)
SELECT 
    dl.id,
    category.name,
    category.description
FROM daily_logs dl
CROSS JOIN (VALUES 
    ('work_performed', 'Completed foundation pour for grid A1-A5'),
    ('deliveries', 'Received 50 tons of rebar for next phase'),
    ('visitors', 'Building inspector site visit - passed inspection'),
    ('safety', 'Conducted weekly safety meeting with all trades')
) AS category(name, description);

-- Insert cost forecasts
INSERT INTO cost_forecasts (budget_item_id, forecast_date, forecast_to_complete, notes, created_by)
SELECT 
    id,
    CURRENT_DATE,
    GREATEST(0, revised_budget - committed_costs - direct_costs),
    'Monthly forecast update',
    '33333333-3333-3333-3333-333333333333'
FROM budget_items
WHERE forecast_to_complete > 0;

-- Insert lien waivers for paid invoices
INSERT INTO lien_waivers (commitment_id, invoice_id, waiver_type, waiver_period, amount, through_date, received_date)
SELECT 
    i.commitment_id,
    i.id,
    'conditional',
    'partial',
    i.total_amount,
    i.billing_period_end,
    i.invoice_date + INTERVAL '5 days'
FROM invoices i
WHERE i.status IN ('approved', 'paid');