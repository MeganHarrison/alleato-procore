#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# 1. Check for Next.js dynamic route conflicts (CRITICAL)
echo ""
echo "ğŸ›£ï¸  Checking Next.js route naming..."
npm run check:routes
if [ $? -ne 0 ]; then
  echo "âŒ Route conflict check FAILED"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "You have conflicting dynamic route names."
  echo "This will break the Next.js dev server."
  echo ""
  echo "See: .agents/rules/CRITICAL-NEXTJS-ROUTING-RULES.md"
  echo ""
  exit 1
fi

# 2. Check for dangerous code patterns
echo ""
.husky/pre-commit-dangerous-patterns
if [ $? -ne 0 ]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  exit 1
fi

# 3. Run documentation structure validation
echo ""
.husky/pre-commit-docs
if [ $? -ne 0 ]; then
  echo "âŒ Documentation structure validation FAILED"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  exit 1
fi

# 4. Run lint-staged to check and fix staged files
echo ""
npx lint-staged

# If lint-staged fails, block the commit
if [ $? -ne 0 ]; then
  echo "âŒ Pre-commit checks FAILED"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Fix the errors above before committing."
  echo "Type errors and lint errors must be fixed."
  echo ""
  exit 1
fi

echo "âœ… Pre-commit checks PASSED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
