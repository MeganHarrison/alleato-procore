name: Codex Issue Handler

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  handle_codex_task:
    # Only run if issue has 'codex' label and not already processing
    if: |
      contains(github.event.issue.labels.*.name, 'codex') &&
      !contains(github.event.issue.labels.*.name, 'codex-processing')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Add processing label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['codex-processing']
            });

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Setup git identity
        run: |
          git config --global user.email "codex[bot]@users.noreply.github.com"
          git config --global user.name "Codex Issue Bot"

      - name: Parse issue type and labels
        id: issue_type
        run: |
          LABELS='${{ toJSON(github.event.issue.labels.*.name) }}'

          # Determine task type from labels
          if echo "$LABELS" | grep -q "feature"; then
            echo "task_type=feature" >> $GITHUB_OUTPUT
            echo "codex_task=refactor-code" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "bug"; then
            echo "task_type=bug" >> $GITHUB_OUTPUT
            echo "codex_task=refactor-code" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "refactor"; then
            echo "task_type=refactor" >> $GITHUB_OUTPUT
            echo "codex_task=refactor-code" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "tests"; then
            echo "task_type=tests" >> $GITHUB_OUTPUT
            echo "codex_task=generate-component-tests" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "migration\|database"; then
            echo "task_type=migration" >> $GITHUB_OUTPUT
            echo "codex_task=create-migration" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "docs\|documentation"; then
            echo "task_type=documentation" >> $GITHUB_OUTPUT
            echo "codex_task=update-documentation" >> $GITHUB_OUTPUT
          else
            echo "task_type=general" >> $GITHUB_OUTPUT
            echo "codex_task=refactor-code" >> $GITHUB_OUTPUT
          fi

      - name: Extract target path from issue
        id: extract_target
        run: |
          ISSUE_BODY='${{ github.event.issue.body }}'

          # Try to extract target path from issue body
          TARGET=$(echo "$ISSUE_BODY" | grep -oP '(?<=Target files:|Target path:|Target:).*' | head -1 | xargs || echo "")

          # Clean up and validate
          TARGET=$(echo "$TARGET" | sed 's/^[- ]*//g' | sed 's/\s*$//g')

          if [ -z "$TARGET" ]; then
            TARGET="frontend/src"
          fi

          echo "target_path=$TARGET" >> $GITHUB_OUTPUT
          echo "Extracted target: $TARGET"

      - name: Create task branch
        id: branch
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          TASK_TYPE=${{ steps.issue_type.outputs.task_type }}
          BRANCH_NAME="codex/issue-${ISSUE_NUM}-${TASK_TYPE}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Comment on issue - Starting
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: `ü§ñ **Codex Task Started**

              **Branch:** \`${{ steps.branch.outputs.branch_name }}\`
              **Task Type:** ${{ steps.issue_type.outputs.task_type }}
              **Target:** ${{ steps.extract_target.outputs.target_path }}

              I'm working on this now. I'll create a PR when complete.

              ---
              *Running in GitHub Actions cloud*`
            });

      - name: Install Codex CLI
        run: |
          # Note: This is a placeholder - replace with actual Codex CLI installation
          # For now, we'll use a mock implementation
          echo "Codex CLI would be installed here"
          # npm install -g @openai/codex

      - name: Create Codex prompt from issue
        id: create_prompt
        run: |
          cat > /tmp/codex_issue_prompt.txt << 'PROMPT_EOF'
          You are Codex automating a development task for Alleato-Procore.

          **Project Context:**
          - Tech Stack: Next.js 15 + TypeScript + Supabase + Playwright
          - Domain: Construction project management
          - Quality Standard: Production-grade, zero type/lint errors
          - Read CLAUDE.md for full standards

          **GitHub Issue Task**

          Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
          Type: ${{ steps.issue_type.outputs.task_type }}
          Target: ${{ steps.extract_target.outputs.target_path }}

          **Issue Description:**
          ${{ github.event.issue.body }}

          **Your Mission:**
          1. Read the issue carefully - understand ALL acceptance criteria
          2. Analyze existing code patterns in the target area
          3. Implement the requested changes
          4. Follow existing patterns and conventions
          5. Ensure TypeScript strict mode compliance
          6. Run quality checks: npm run quality --prefix frontend
          7. Run build: npm run build --prefix frontend
          8. If tests mentioned, create/update Playwright tests

          **Quality Requirements (MANDATORY):**
          - Zero TypeScript errors
          - Zero ESLint errors
          - Build must succeed
          - Follow patterns in CLAUDE.md
          - Use existing component patterns
          - Proper types (no 'any')

          **Forbidden:**
          - Using @ts-ignore or @ts-expect-error
          - Using 'any' type
          - console.log statements
          - Breaking existing functionality
          - Skipping quality checks

          Complete this task to production standards. Only stop if genuinely blocked.
          PROMPT_EOF

          echo "Prompt created at /tmp/codex_issue_prompt.txt"

      - name: Execute Codex Task (Simulated)
        id: execute
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # PLACEHOLDER: Replace with actual Codex execution
          # For now, simulate with Claude Code or manual implementation

          echo "ü§ñ Codex would execute here with prompt:"
          cat /tmp/codex_issue_prompt.txt

          # Actual command would be:
          # codex exec \
          #   --prompt-file /tmp/codex_issue_prompt.txt \
          #   --workspace ./ \
          #   --full-auto

          # For now, mark as placeholder
          echo "execution_status=placeholder" >> $GITHUB_OUTPUT

      - name: Run quality checks
        id: quality
        continue-on-error: true
        run: |
          cd frontend

          echo "Running TypeScript check..."
          npm run typecheck || echo "typecheck_failed=true" >> $GITHUB_OUTPUT

          echo "Running ESLint..."
          npm run lint || echo "lint_failed=true" >> $GITHUB_OUTPUT

          echo "Running build..."
          npm run build || echo "build_failed=true" >> $GITHUB_OUTPUT

          # Check if all passed
          if [ -z "$typecheck_failed" ] && [ -z "$lint_failed" ] && [ -z "$build_failed" ]; then
            echo "quality_status=success" >> $GITHUB_OUTPUT
          else
            echo "quality_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        id: commit
        if: steps.quality.outputs.quality_status == 'success'
        run: |
          git add .

          # Check if there are changes
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            git commit -m "feat(#${{ github.event.issue.number }}): ${{ github.event.issue.title }}

            Implements #${{ github.event.issue.number }}

            Task type: ${{ steps.issue_type.outputs.task_type }}
            Target: ${{ steps.extract_target.outputs.target_path }}

            Automated by Codex CLI via GitHub Actions
            Verified: typecheck ‚úì lint ‚úì build ‚úì

            Co-Authored-By: Codex Bot <codex[bot]@users.noreply.github.com>"

            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Push branch
        if: steps.commit.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.branch_name }}

      - name: Create PR
        if: steps.commit.outputs.has_changes == 'true'
        id: create_pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ü§ñ #${{ github.event.issue.number }}: ${{ github.event.issue.title }}`,
              head: '${{ steps.branch.outputs.branch_name }}',
              base: 'main',
              body: `## Implements #${{ github.event.issue.number }}

            ### Original Issue
            **Title:** ${{ github.event.issue.title }}
            **Type:** ${{ steps.issue_type.outputs.task_type }}
            **Target:** ${{ steps.extract_target.outputs.target_path }}

            **Link:** #${{ github.event.issue.number }}

            ### What Changed
            This PR implements the requirements specified in the linked issue.

            ### Verification ‚úÖ
            - ‚úÖ TypeScript type check passed
            - ‚úÖ ESLint check passed
            - ‚úÖ Build successful

            ### Quality Gates
            All automated quality checks have passed. The code:
            - Has zero TypeScript errors
            - Has zero ESLint violations
            - Builds successfully
            - Follows project patterns and conventions

            ### Review Checklist
            - [ ] All acceptance criteria from issue met
            - [ ] Tests pass (if applicable)
            - [ ] No breaking changes
            - [ ] Documentation updated (if needed)
            - [ ] Codex PR review comments addressed

            ---
            ü§ñ *Automated by Codex CLI via GitHub Actions*

            This will trigger the Codex PR Review workflow for additional validation.

            Closes #${{ github.event.issue.number }}`
            });

            core.setOutput('pr_number', pr.data.number);
            return pr.data.number;

      - name: Comment on issue - Success
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: `ü§ñ **Codex Task Complete** ‚úÖ

            **Pull Request:** #${{ steps.create_pr.outputs.result }}
            **Branch:** \`${{ steps.branch.outputs.branch_name }}\`

            ### What I Did
            - ‚úÖ Analyzed issue requirements
            - ‚úÖ Implemented changes
            - ‚úÖ Passed TypeScript typecheck
            - ‚úÖ Passed ESLint
            - ‚úÖ Build successful
            - ‚úÖ Created pull request

            ### Next Steps
            1. **Codex PR Review** will automatically run on the PR
            2. Review the PR and any automated comments
            3. Merge when satisfied

            The PR is ready for your review!

            ---
            *Automated execution completed in ${{ github.run_id }}*`
            });

            // Remove processing label, add completed label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              name: 'codex-processing'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              labels: ['codex-completed']
            });

      - name: Comment on issue - No Changes
        if: steps.commit.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: `ü§ñ **Codex Task Complete - No Changes Needed**

            I analyzed the issue but determined no code changes are necessary.

            This could mean:
            - The requested functionality already exists
            - The issue was already resolved
            - The task requires manual intervention

            Please review and clarify if needed.`
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              name: 'codex-processing'
            });

      - name: Comment on issue - Quality Failure
        if: steps.quality.outputs.quality_status == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const typecheck = '${{ steps.quality.outputs.typecheck_failed }}' === 'true' ? '‚ùå' : '‚úÖ';
            const lint = '${{ steps.quality.outputs.lint_failed }}' === 'true' ? '‚ùå' : '‚úÖ';
            const build = '${{ steps.quality.outputs.build_failed }}' === 'true' ? '‚ùå' : '‚úÖ';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: `ü§ñ **Codex Task Failed - Quality Checks** ‚ùå

            I attempted to complete the task but the code didn't pass quality checks.

            ### Quality Check Results
            - ${typecheck} TypeScript typecheck
            - ${lint} ESLint
            - ${build} Build

            ### What Happened
            The implementation has errors that need to be fixed before creating a PR.

            ### Next Steps
            1. Check the workflow logs for detailed error messages
            2. The branch \`${{ steps.branch.outputs.branch_name }}\` has the changes
            3. You can manually fix the errors and push, or
            4. Adjust the issue description and re-label to try again

            ---
            *Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*`
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              name: 'codex-processing'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              labels: ['codex-failed']
            });

      - name: Comment on issue - Execution Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: `ü§ñ **Codex Task Failed - Workflow Error** ‚ùå

            The workflow encountered an error during execution.

            ### What Happened
            An unexpected error occurred while processing this issue.

            ### Next Steps
            1. Check the workflow logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            2. Verify the issue format matches the template
            3. Try manually triggering via workflow dispatch
            4. Contact maintainers if issue persists

            ---
            *Automated execution failed in run ${{ github.run_id }}*`
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              name: 'codex-processing'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              labels: ['codex-failed']
            });
