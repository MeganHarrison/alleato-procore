name: Codex PR Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - 'frontend/**/*.ts'
      - 'frontend/**/*.tsx'
      - 'frontend/**/*.js'
      - 'frontend/**/*.jsx'
      - 'supabase/**/*.sql'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  codex_review:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: files
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx|sql)$' || echo "")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Codex Code Review
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            $(cat .github/prompts/pr-review.txt)

            **Pull Request Details:**
            - PR Number: #${{ github.event.pull_request.number }}
            - Title: ${{ github.event.pull_request.title }}
            - Author: ${{ github.event.pull_request.user.login }}
            - Base Branch: ${{ github.base_ref }}
            - Head Branch: ${{ github.head_ref }}

            **Changed Files:**
            ${{ steps.files.outputs.files }}

            **Diff:**
            ${{ steps.diff.outputs.diff }}

            Review this pull request and provide detailed feedback following the review criteria.

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const review = process.env.CODEX_OUTPUT || 'No review output generated';

            const body = `## ü§ñ Codex Code Review

            ${review}

            ---
            *Automated review by OpenAI Codex*
            *Review based on Alleato-Procore production standards*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Check for critical issues
        if: contains(env.CODEX_OUTPUT, 'CRITICAL')
        run: |
          echo "‚ö†Ô∏è CRITICAL issues found in code review"
          echo "Please address all CRITICAL issues before merging"
          exit 1
