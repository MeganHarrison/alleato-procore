name: Codex Task Automation

on:
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Type of task to automate'
        required: true
        type: choice
        options:
          - generate-supabase-types
          - generate-component-tests
          - update-documentation
          - refactor-code
          - create-migration
      target_path:
        description: 'Target file/directory path (if applicable)'
        required: false
        type: string
      task_description:
        description: 'Detailed task description'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  execute_task:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Setup git identity
        run: |
          git config --global user.email "codex[bot]@users.noreply.github.com"
          git config --global user.name "Codex Task Bot"

      - name: Create task branch
        id: branch
        run: |
          BRANCH_NAME="codex-task-${{ github.event.inputs.task_type }}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Execute Task - Generate Supabase Types
        if: github.event.inputs.task_type == 'generate-supabase-types'
        run: |
          cd frontend
          npx supabase gen types typescript \
            --project-id "lgveqfnpkxvzbnnwuled" \
            --schema public > src/types/database.types.ts
          echo "Generated Supabase types successfully"

      - name: Execute Task - Generate Component Tests
        if: github.event.inputs.task_type == 'generate-component-tests'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > /tmp/test_gen_prompt.txt << 'PROMPT_EOF'
          $(cat .github/prompts/task-automation.txt)

          **Task:** Generate Playwright E2E tests

          **Target Component:** ${{ github.event.inputs.target_path }}

          **Requirements:**
          1. Create comprehensive E2E tests in `frontend/tests/e2e/`
          2. Follow existing test patterns in the codebase
          3. Include visual regression tests if UI-focused
          4. Test user interactions and workflows
          5. Use proper TypeScript types
          6. Include setup and teardown as needed

          **Additional Context:**
          ${{ github.event.inputs.task_description }}

          Generate complete, production-ready tests.
          PROMPT_EOF

          codex exec \
            --prompt-file /tmp/test_gen_prompt.txt \
            --workspace ./frontend \
            --full-auto

      - name: Execute Task - Update Documentation
        if: github.event.inputs.task_type == 'update-documentation'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > /tmp/docs_prompt.txt << 'PROMPT_EOF'
          $(cat .github/prompts/task-automation.txt)

          **Task:** Update Documentation

          **Target:** ${{ github.event.inputs.target_path || 'General project documentation' }}

          **Instructions:**
          ${{ github.event.inputs.task_description }}

          **Requirements:**
          1. Update PLANS_DOC.md if feature-related
          2. Update README if setup/usage changed
          3. Add inline code comments for complex logic
          4. Keep documentation accurate and concise
          5. Follow existing documentation style

          Update all relevant documentation.
          PROMPT_EOF

          codex exec \
            --prompt-file /tmp/docs_prompt.txt \
            --workspace ./ \
            --full-auto

      - name: Execute Task - Refactor Code
        if: github.event.inputs.task_type == 'refactor-code'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > /tmp/refactor_prompt.txt << 'PROMPT_EOF'
          $(cat .github/prompts/task-automation.txt)

          **Task:** Code Refactoring

          **Target:** ${{ github.event.inputs.target_path }}

          **Refactoring Goals:**
          ${{ github.event.inputs.task_description }}

          **Requirements:**
          1. Maintain existing functionality (no breaking changes)
          2. Improve code quality and readability
          3. Follow existing patterns and conventions
          4. Ensure all types are correct
          5. Keep test coverage intact or improve it
          6. Run quality checks after refactoring

          **Forbidden:**
          - Breaking changes without explicit approval
          - Removing functionality
          - Using `any` type
          - Skipping quality checks

          Refactor the code while maintaining production quality.
          PROMPT_EOF

          codex exec \
            --prompt-file /tmp/refactor_prompt.txt \
            --workspace ./frontend \
            --full-auto

      - name: Execute Task - Create Migration
        if: github.event.inputs.task_type == 'create-migration'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          MIGRATION_DATE=$(date +%Y%m%d)
          MIGRATION_NAME="${{ github.event.inputs.task_description }}"

          cat > /tmp/migration_prompt.txt << 'PROMPT_EOF'
          $(cat .github/prompts/task-automation.txt)

          **Task:** Create Database Migration

          **Migration Description:**
          ${{ github.event.inputs.task_description }}

          **Requirements:**
          1. Create migration file: `supabase/migrations/${MIGRATION_DATE}_${MIGRATION_NAME}.sql`
          2. Follow Supabase migration best practices
          3. Include proper RLS policies if creating tables
          4. Add helpful comments in SQL
          5. After creating migration, regenerate types:
             ```
             npx supabase gen types typescript \
               --project-id "lgveqfnpkxvzbnnwuled" \
               --schema public > frontend/src/types/database.types.ts
             ```

          Create a production-ready migration.
          PROMPT_EOF

          codex exec \
            --prompt-file /tmp/migration_prompt.txt \
            --workspace ./ \
            --full-auto

      - name: Run quality checks
        id: quality
        run: |
          cd frontend
          echo "Running TypeScript check..."
          npm run typecheck
          echo "Running ESLint..."
          npm run lint
          echo "Running build..."
          npm run build
          echo "quality_status=success" >> $GITHUB_OUTPUT

      - name: Run tests if applicable
        if: github.event.inputs.task_type == 'generate-component-tests' || github.event.inputs.task_type == 'refactor-code'
        continue-on-error: true
        run: |
          cd frontend
          npm run test:e2e

      - name: Commit changes
        if: steps.quality.outputs.quality_status == 'success'
        run: |
          git add .
          git commit -m "feat(automation): ${{ github.event.inputs.task_type }}

          Task: ${{ github.event.inputs.task_type }}
          Target: ${{ github.event.inputs.target_path || 'N/A' }}
          Description: ${{ github.event.inputs.task_description || 'Automated task' }}

          Verified: typecheck âœ“ lint âœ“ build âœ“

          Automated by Codex CLI" || echo "No changes to commit"

      - name: Push changes
        if: steps.quality.outputs.quality_status == 'success'
        run: |
          git push origin ${{ steps.branch.outputs.branch_name }}

      - name: Create PR
        if: steps.quality.outputs.quality_status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const taskType = '${{ github.event.inputs.task_type }}';
            const target = '${{ github.event.inputs.target_path }}' || 'General';
            const description = '${{ github.event.inputs.task_description }}' || 'Automated task execution';

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– Automated Task: ${taskType}`,
              head: '${{ steps.branch.outputs.branch_name }}',
              base: 'main',
              body: `## Automated Task Execution

              ### Task Details
              - **Type:** ${taskType}
              - **Target:** ${target}
              - **Description:** ${description}

              ### What Changed
              This PR contains changes generated by Codex CLI for the requested automation task.

              ### Verification
              - âœ… TypeScript type check passed
              - âœ… ESLint check passed
              - âœ… Build successful

              ### Review Checklist
              - [ ] Review generated code for correctness
              - [ ] Verify tests pass (if applicable)
              - [ ] Check for any security concerns
              - [ ] Confirm changes align with requirements

              ---
              ðŸ¤– *Automated by Codex CLI*

              Triggered by: @${{ github.actor }}`
            });

            core.setOutput('pr_number', pr.data.number);
            console.log('Created PR #' + pr.data.number);

      - name: Report failure
        if: steps.quality.outputs.quality_status != 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– Task Automation Failed: ${{ github.event.inputs.task_type }}`,
              body: `## Task Automation Failure

              **Task Type:** ${{ github.event.inputs.task_type }}
              **Target:** ${{ github.event.inputs.target_path || 'N/A' }}
              **Branch:** ${{ steps.branch.outputs.branch_name }}

              The automated task failed quality checks. Manual intervention required.

              **Triggered by:** @${{ github.actor }}

              Please review the workflow logs and fix any issues.`,
              labels: ['automation', 'failed', 'needs-investigation']
            });
