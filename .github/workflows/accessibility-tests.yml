name: Accessibility Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  accessibility:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
    
    - name: Run accessibility tests
      run: npx playwright test accessibility --reporter=json --reporter=html
      env:
        CI: true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: accessibility-report
        path: |
          playwright-report/
          test-results/
          test_screenshots/accessibility/
        retention-days: 30
    
    - name: Parse accessibility results
      if: always()
      run: |
        if [ -f "test-results.json" ]; then
          echo "## Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract summary from JSON results
          node -e "
            const results = require('./test-results.json');
            const passed = results.stats.expected;
            const failed = results.stats.unexpected;
            const total = passed + failed;
            
            console.log('| Metric | Value |');
            console.log('|--------|--------|');
            console.log('| Total Tests | ' + total + ' |');
            console.log('| Passed | ' + passed + ' |');
            console.log('| Failed | ' + failed + ' |');
            console.log('| Pass Rate | ' + ((passed/total)*100).toFixed(1) + '% |');
          " >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
          
          # List failed tests
          node -e "
            const results = require('./test-results.json');
            results.suites.forEach(suite => {
              suite.specs.forEach(spec => {
                if (spec.ok === false) {
                  console.log('- ' + spec.title);
                }
              });
            });
          " >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comment = '## üîç Accessibility Test Results\n\n';
          
          try {
            const results = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
            const passed = results.stats.expected;
            const failed = results.stats.unexpected;
            const total = passed + failed;
            
            if (failed === 0) {
              comment += '‚úÖ **All accessibility tests passed!**\n\n';
            } else {
              comment += `‚ö†Ô∏è **${failed} accessibility issues found**\n\n`;
            }
            
            comment += `| Total Tests | Passed | Failed | Pass Rate |\n`;
            comment += `|-------------|---------|---------|------------|\n`;
            comment += `| ${total} | ${passed} | ${failed} | ${((passed/total)*100).toFixed(1)}% |\n`;
            
            if (failed > 0) {
              comment += '\n### Failed Tests:\n';
              results.suites.forEach(suite => {
                suite.specs.forEach(spec => {
                  if (!spec.ok) {
                    comment += `- ${spec.title}\n`;
                  }
                });
              });
            }
          } catch (error) {
            comment += '‚ùå Failed to parse test results\n';
          }
          
          comment += '\n[View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Fail if accessibility issues found
      if: failure()
      run: |
        echo "‚ùå Accessibility tests failed. Please fix the issues before merging."
        exit 1