name: Progressive Test Levels

# This workflow implements progressive difficulty testing similar to the
# "AI Fixed My Code While I Slept" video. Each level increases in complexity,
# with Level 3 being an intentional "trap" to test unfixable failure detection.

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: '20'

jobs:
  level-1-basic:
    name: "Level 1: Basic Type & Lint Errors"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Level 1 - TypeScript type check
        id: typecheck
        working-directory: ./frontend
        run: npm run typecheck 2>&1 | tee level-1-typecheck.log
        continue-on-error: true

      - name: Level 1 - ESLint check
        id: eslint
        working-directory: ./frontend
        run: npm run lint 2>&1 | tee level-1-lint.log
        continue-on-error: true

      - name: Upload Level 1 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: level-1-failures-${{ github.run_id }}
          path: |
            frontend/level-1-typecheck.log
            frontend/level-1-lint.log
          retention-days: 7

      - name: Level 1 Summary
        if: always()
        run: |
          echo "## Level 1: Basic Errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.typecheck.outcome }}" == "success" && "${{ steps.eslint.outcome }}" == "success" ]]; then
            echo "âœ… **PASSED** - No type or lint errors" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAILED** - Basic errors detected" >> $GITHUB_STEP_SUMMARY
            echo "- TypeScript: ${{ steps.typecheck.outcome }}" >> $GITHUB_STEP_SUMMARY
            echo "- ESLint: ${{ steps.eslint.outcome }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Expected Fix:** Claude should fix these automatically" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if Level 1 failed
        if: steps.typecheck.outcome == 'failure' || steps.eslint.outcome == 'failure'
        run: exit 1

  level-2-complex:
    name: "Level 2: Integration & E2E Tests"
    runs-on: ubuntu-latest
    needs: level-1-basic
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      - name: Level 2 - Run E2E tests
        id: e2e
        working-directory: ./frontend
        run: npx playwright test 2>&1 | tee level-2-tests.log
        continue-on-error: true
        env:
          CI: true
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'placeholder-key' }}

      - name: Upload Level 2 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: level-2-failures-${{ github.run_id }}
          path: |
            frontend/level-2-tests.log
            frontend/playwright-report/
            frontend/test-results/
            frontend/tests/screenshots/
          retention-days: 7

      - name: Level 2 Summary
        if: always()
        run: |
          echo "## Level 2: Complex Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.e2e.outcome }}" == "success" ]]; then
            echo "âœ… **PASSED** - All E2E tests passing" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAILED** - E2E test failures" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Expected Fix:** Claude should:" >> $GITHUB_STEP_SUMMARY
            echo "- Fix selector issues" >> $GITHUB_STEP_SUMMARY
            echo "- Update test expectations" >> $GITHUB_STEP_SUMMARY
            echo "- Skip flaky tests with explanation" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if Level 2 failed
        if: steps.e2e.outcome == 'failure'
        run: exit 1

  level-3-trap:
    name: "Level 3: External Dependencies (Trap)"
    runs-on: ubuntu-latest
    needs: level-2-complex

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Level 3 - External API health check
        id: external_api
        run: |
          # Test external dependencies that might be unreachable
          echo "Testing external API availability..."

          # Try to reach a potentially unavailable external service
          # This simulates the video's 404 trap scenario
          curl --fail --max-time 10 https://httpstat.us/503 > external-response.html 2>&1 | tee external-api.log || true

          if [ $? -ne 0 ]; then
            echo "External API check failed"
            echo "HTTP 503 Service Unavailable" > error-context.txt
            echo "External dependency is down - this cannot be fixed in code" >> error-context.txt
            exit 1
          fi
        continue-on-error: true

      - name: Level 3 - Missing environment variable test
        id: env_check
        run: |
          # Test for missing critical environment variable
          echo "Checking for CRITICAL_API_KEY..."

          if [ -z "$CRITICAL_API_KEY" ]; then
            echo "ERROR: Missing required environment variable: CRITICAL_API_KEY" | tee env-error.log
            echo "This is an infrastructure issue - requires GitHub secrets configuration" >> env-error.log
            exit 1
          fi
        continue-on-error: true
        env:
          CRITICAL_API_KEY: ${{ secrets.CRITICAL_API_KEY }}

      - name: Upload Level 3 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: level-3-trap-${{ github.run_id }}
          path: |
            external-response.html
            external-api.log
            error-context.txt
            env-error.log
          retention-days: 7

      - name: Level 3 Summary
        if: always()
        run: |
          echo "## Level 3: Unfixable Failures (Trap)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **PURPOSE:** Test Claude's ability to detect unfixable failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.external_api.outcome }}" == "failure" ]]; then
            echo "âŒ External API: **FAILED** (Expected)" >> $GITHUB_STEP_SUMMARY
            echo "   - Reason: HTTP 503 Service Unavailable" >> $GITHUB_STEP_SUMMARY
            echo "   - **Expected Behavior:** Claude should NOT attempt code fixes" >> $GITHUB_STEP_SUMMARY
            echo "   - **Expected Action:** Add comment explaining external dependency failure" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ steps.env_check.outcome }}" == "failure" ]]; then
            echo "âŒ Environment Check: **FAILED** (Expected)" >> $GITHUB_STEP_SUMMARY
            echo "   - Reason: Missing CRITICAL_API_KEY secret" >> $GITHUB_STEP_SUMMARY
            echo "   - **Expected Behavior:** Claude should NOT patch code" >> $GITHUB_STEP_SUMMARY
            echo "   - **Expected Action:** Add comment documenting infrastructure requirement" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **CRITICAL TEST:** If Claude attempts to 'fix' these with code changes, the unfixable detection logic has failed." >> $GITHUB_STEP_SUMMARY

      - name: Fail if Level 3 failed (expected)
        if: steps.external_api.outcome == 'failure' || steps.env_check.outcome == 'failure'
        run: |
          echo "Level 3 failed as expected - this tests unfixable failure detection"
          exit 1

  summary:
    name: Progressive Test Summary
    needs: [level-1-basic, level-2-complex, level-3-trap]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Test Level Summary
        run: |
          echo "## ðŸŽ¯ Progressive Test Levels Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Level | Type | Result | Expected Claude Behavior |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|--------|--------------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Basic Errors | ${{ needs.level-1-basic.result }} | Auto-fix type/lint errors |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Complex Tests | ${{ needs.level-2-complex.result }} | Fix or skip with explanation |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Trap (Unfixable) | ${{ needs.level-3-trap.result }} | Document, do NOT fix |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.level-3-trap.result }}" == "failure" ]]; then
            echo "âœ… **Level 3 Trap Working:** Unfixable failures detected correctly" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "When auto-fix workflow runs, Claude should:" >> $GITHUB_STEP_SUMMARY
            echo "1. Recognize external/infrastructure failures" >> $GITHUB_STEP_SUMMARY
            echo "2. Add comments instead of code changes" >> $GITHUB_STEP_SUMMARY
            echo "3. NOT attempt to 'work around' unfixable issues" >> $GITHUB_STEP_SUMMARY
          fi
