# Deployment Guide - Best Practices

This document outlines the **correct, efficient way** to deploy and manage the Alleato-Procore application.

## Table of Contents
- [Philosophy: CLI-First Approach](#philosophy-cli-first-approach)
- [Backend Deployment (Render)](#backend-deployment-render)
- [Frontend Deployment (Vercel)](#frontend-deployment-vercel)
- [Environment Variables Management](#environment-variables-management)
- [Common Anti-Patterns to Avoid](#common-anti-patterns-to-avoid)

---

## Philosophy: CLI-First Approach

**ALWAYS use CLI tools instead of web dashboards when possible.**

### Why CLI > Dashboard:
1. **Faster** - No clicking through UI
2. **Scriptable** - Can be automated
3. **Reproducible** - Clear audit trail
4. **Version controllable** - Can be documented in scripts
5. **Efficient** - Single command vs multiple clicks

### Required Tools:
```bash
# Install Render CLI
brew install render

# Install Vercel CLI
npm i -g vercel

# Verify installations
render --version
vercel --version
```

---

## Backend Deployment (Render)

### Initial Setup

**Option 1: Blueprint (Recommended - One Command)**
```bash
# From project root
render blueprint launch

# This reads render.yaml and sets up everything automatically
# You'll be prompted for environment variables marked with sync: false
```

**Option 2: Manual Setup (NOT Recommended)**
Using the Render dashboard is slower and error-prone. Always use the blueprint.

### Environment Variables

**Set via CLI (Fast & Efficient):**
```bash
# List all services
render services list

# Add/update environment variable
render env set OPENAI_API_KEY=sk-proj-xxx... --service alleato-backend

# View current env vars
render env list --service alleato-backend
```

**DO NOT use Render dashboard for env vars** - the CLI is faster and scriptable.

### Deployment

Backend deploys **automatically** when you push to `main`:
```bash
git push origin main
```

**Manual deploy (if needed):**
```bash
render deploy --service alleato-backend
```

**View logs:**
```bash
render logs --service alleato-backend --tail
```

### Health Check
```bash
curl https://alleato-pm-1.onrender.com/health | jq
```

---

## Frontend Deployment (Vercel)

### Initial Setup

**Link project (one-time):**
```bash
cd frontend
vercel link --yes
```

This creates `.vercel/` directory and links to your Vercel project.

### Environment Variables

**ALWAYS use CLI for environment variables:**

```bash
# Add new variable
echo "value-here" | vercel env add VAR_NAME production

# Update existing variable (--force overwrites)
echo "new-value" | vercel env add VAR_NAME production --force

# List all env vars
vercel env ls production

# Pull env vars to local .env.local
vercel env pull .env.local
```

**Example: Update backend URL**
```bash
echo "https://alleato-pm-1.onrender.com" | vercel env add NEXT_PUBLIC_AGENT_ENDPOINT production --force
echo "https://alleato-pm-1.onrender.com" | vercel env add PYTHON_BACKEND_URL production --force
```

### Deployment

**Auto-deploy (Recommended):**
Frontend deploys automatically when you push to `main`. To trigger redeploy after env var changes:
```bash
git commit --allow-empty -m "chore: trigger redeploy"
git push origin main
```

**Manual deploy (Alternative):**
```bash
cd frontend
vercel --prod
```

**View deployment status:**
```bash
vercel ls
```

---

## Environment Variables Management

### Development (.env files)

**Frontend:**
- `.env` - Local development (gitignored)
- `.env.local` - Auto-generated by `vercel env pull` (gitignored)
- **NEVER commit .env files** - they contain secrets

**Backend:**
- `.env` - Local development (gitignored)
- In production, Render sets env vars directly (no .env file)

### Production (Platform-managed)

**Vercel (Frontend):**
```bash
# Set for all environments
vercel env add VAR_NAME

# Set for specific environment
vercel env add VAR_NAME production
vercel env add VAR_NAME preview
vercel env add VAR_NAME development

# Update existing
vercel env add VAR_NAME production --force
```

**Render (Backend):**
```bash
# Set environment variable
render env set VAR_NAME=value --service alleato-backend

# Remove environment variable
render env unset VAR_NAME --service alleato-backend
```

### Required Environment Variables

**Backend (Render):**
```bash
OPENAI_API_KEY=sk-proj-...
SUPABASE_URL=https://lgveqfnpkxvzbnnwuled.supabase.co
SUPABASE_SERVICE_KEY=sb_secret_...
SUPABASE_ANON_KEY=sb_publishable_...
USE_UNIFIED_AGENT=true
CORS_ORIGINS=https://alleato-procore.vercel.app,https://www.alleato-procore.vercel.app,https://alleato-pm-1.onrender.com
```

**Frontend (Vercel):**
```bash
NEXT_PUBLIC_AGENT_ENDPOINT=https://alleato-pm-1.onrender.com
PYTHON_BACKEND_URL=https://alleato-pm-1.onrender.com
NEXT_PUBLIC_SUPABASE_URL=https://lgveqfnpkxvzbnnwuled.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_...
# ... (see .env for full list)
```

---

## Common Anti-Patterns to Avoid

### ❌ DON'T: Use web dashboards for routine tasks
```
Going to Render dashboard → Settings → Environment → Edit
Going to Vercel dashboard → Settings → Environment Variables → Edit
```

### ✅ DO: Use CLI
```bash
render env set KEY=value --service alleato-backend
vercel env add KEY production --force <<< "value"
```

---

### ❌ DON'T: Manually trigger deploys in dashboard
```
Render dashboard → Manual Deploy → Deploy latest commit
```

### ✅ DO: Push to git or use CLI
```bash
git push origin main  # Auto-deploys both platforms

# OR for manual:
render deploy --service alleato-backend
vercel --prod
```

---

### ❌ DON'T: Commit .env files
```bash
git add .env
git commit -m "Add environment variables"  # DANGEROUS!
```

### ✅ DO: Keep .env gitignored, use platform tools
```bash
# .env is in .gitignore
vercel env add KEY production <<< "value"
render env set KEY=value --service alleato-backend
```

---

### ❌ DON'T: Edit production config files manually in dashboard
```
Opening Render dashboard → Edit render.yaml equivalent settings
```

### ✅ DO: Edit render.yaml/vercel.json and commit
```bash
# Edit render.yaml locally
vim render.yaml

# Commit and push
git add render.yaml
git commit -m "config: update CORS origins"
git push origin main  # Render picks up changes automatically
```

---

### ❌ DON'T: Check logs in dashboard
```
Opening Render dashboard → Logs tab → Scrolling
```

### ✅ DO: Use CLI for live logs
```bash
render logs --service alleato-backend --tail
vercel logs --follow
```

---

## Quick Reference Commands

### Render (Backend)
```bash
# Setup
render blueprint launch

# Deploy
git push origin main  # Auto-deploy
render deploy --service alleato-backend  # Manual

# Env vars
render env set KEY=value --service alleato-backend
render env list --service alleato-backend

# Logs
render logs --service alleato-backend --tail

# Status
render services list
```

### Vercel (Frontend)
```bash
# Setup
vercel link --yes

# Deploy
git push origin main  # Auto-deploy
vercel --prod  # Manual

# Env vars
echo "value" | vercel env add KEY production --force
vercel env ls production
vercel env pull .env.local

# Logs
vercel logs --follow

# Status
vercel ls
```

---

## Production URLs

**Backend:** https://alleato-pm-1.onrender.com
**Frontend:** https://alleato-procore.vercel.app

**Health Checks:**
```bash
# Backend
curl https://alleato-pm-1.onrender.com/health | jq

# Frontend (should load homepage)
curl -I https://alleato-procore.vercel.app
```

---

## Troubleshooting

### Backend won't start
```bash
# Check logs
render logs --service alleato-backend --tail

# Verify env vars are set
render env list --service alleato-backend

# Test health endpoint
curl https://alleato-pm-1.onrender.com/health
```

### Frontend env vars not updating
```bash
# Verify vars are set
vercel env ls production

# Trigger redeploy
git commit --allow-empty -m "chore: trigger redeploy"
git push origin main

# Check deployment logs
vercel logs
```

### CORS errors
```bash
# Update backend CORS_ORIGINS
render env set CORS_ORIGINS="https://alleato-procore.vercel.app,https://www.alleato-procore.vercel.app,https://alleato-pm-1.onrender.com" --service alleato-backend

# Or edit render.yaml and push
vim render.yaml  # Update CORS_ORIGINS
git add render.yaml && git commit -m "fix: update CORS" && git push
```

---

## Best Practices Summary

1. **Always use CLI over dashboards** - Faster, scriptable, reproducible
2. **Never commit secrets** - Use platform env var management
3. **Use auto-deploy** - Push to git, let platforms handle deployment
4. **Document in code** - render.yaml, vercel.json are the source of truth
5. **Test locally first** - Use .env for local development
6. **Monitor with CLI** - `tail` logs, don't poll dashboards
7. **Script repetitive tasks** - Create shell scripts for common workflows

---

## Automation Scripts

Create these in `scripts/` directory:

**`scripts/deploy-backend.sh`:**
```bash
#!/bin/bash
set -e

echo "Deploying backend to Render..."
git push origin main
echo "✅ Backend deployment triggered"
echo "Monitor: render logs --service alleato-backend --tail"
```

**`scripts/update-backend-env.sh`:**
```bash
#!/bin/bash
set -e

if [ -z "$1" ] || [ -z "$2" ]; then
  echo "Usage: ./update-backend-env.sh KEY VALUE"
  exit 1
fi

render env set "$1=$2" --service alleato-backend
echo "✅ Updated $1 on alleato-backend"
```

**`scripts/deploy-frontend.sh`:**
```bash
#!/bin/bash
set -e

echo "Deploying frontend to Vercel..."
cd frontend
vercel --prod
echo "✅ Frontend deployed"
```

Make them executable:
```bash
chmod +x scripts/*.sh
```

---

## Further Reading

- [Render Blueprint Spec](https://render.com/docs/blueprint-spec)
- [Vercel CLI Reference](https://vercel.com/docs/cli)
- [Environment Variables Best Practices](https://12factor.net/config)

---

**Last Updated:** 2025-12-18
**Deployment URLs:**
- Backend: https://alleato-pm-1.onrender.com
- Frontend: https://alleato-procore.vercel.app
