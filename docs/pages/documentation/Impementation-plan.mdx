# Procore Video Walkthrough Implementation Plan

## Executive Summary

This document outlines the implementation plan for achieving the construction project management functionality demonstrated in the Procore walkthrough video. The plan includes database schema updates, page creation/enhancements, and workflow implementations.

## Video Walkthrough Key Features

https://www.loom.com/share/d690a26c8edb44c29e7e78a3e7dc7d00

### 1. Project Creation and Setup
- Project creation with standard templates
- Project details: number, name, stage, type, square footage, value
- Cost code configuration
- Team member assignment (project managers, subcontractors)
- Document upload areas (drawings, specifications)

### 2. Budget Management
- Manual budget entry and import functionality
- Budget line items with cost codes
- Budget locking mechanism
- Budget modifications (moving money between line items)
- Forecast calculations and over/under tracking

### 3. Prime Contracts
- Contract creation with client selection
- Schedule of Values (SOV) setup
- Retention settings
- Vertical markup configuration (insurance, bonds, fees)
- Compound calculation settings
- Contract status management (draft, approved, executed)

### 4. Commitments (Subcontracts)
- Subcontract creation
- Schedule of Values submission by subcontractors
- Scope inclusions/exclusions
- Invoice contacts assignment
- PDF export capability

### 5. Financial Calculations
- Original budget + budget modifications + approved change orders = revised budget
- Committed cost + direct cost + pending cost changes = projected cost
- Projected budget - projected cost = forecast to complete
- Projected cost + forecast to complete = estimated cost at completion

## Current System Analysis

### ✅ Existing Functionality
1. **Database Tables**: Projects, budget_items, prime_contracts, commitments, cost_codes, change_orders
2. **Frontend Pages**: Project form, budget page, contracts page, commitments page
3. **Components**: ScheduleOfValuesGrid, CostCodeSelector, financial formatters
4. **Features**: Basic CRUD operations, some financial calculations

### ❌ Missing Functionality
1. **Database**: Schedule of values table, billing periods, cost code types, vertical markup settings
2. **Workflow**: Project setup wizard, budget import/export, SOV submission process
3. **Features**: Budget locking, budget modifications tracking, compound calculations
4. **Pages**: Cost code management, comprehensive contract details, billing/invoicing

## Implementation Plan

### Phase 1: Database Schema Updates (Week 1)

#### Phase 1 Detailed Checklist

**Pre-Phase 1 Requirements:**
- [ ] Run schema validation script: `cd backend && ./scripts/check_schema.sh`
- [ ] Backup existing database
- [ ] Generate current database types: `cd backend && npx supabase gen types typescript --local > src/types/database.types.ts`
- [ ] Create new migration files in sequential order

**Database Tables Creation:**
- [ ] Create `schedule_of_values` table migration
  - [ ] Add primary key and foreign key constraints
  - [ ] Add status enum ('draft', 'pending_approval', 'approved', 'revised')
  - [ ] Add either_contract_or_commitment constraint
  - [ ] Test table creation locally
- [ ] Create `sov_line_items` table migration
  - [ ] Add cascade delete on sov_id foreign key
  - [ ] Add percentage calculation as generated column
  - [ ] Verify percentage calculation works correctly
  - [ ] Test with sample data
- [ ] Create `billing_periods` table migration
  - [ ] Add unique constraint on project_id + period_number
  - [ ] Add status enum ('open', 'in_progress', 'closed')
  - [ ] Create index on project_id
- [ ] Create `cost_code_types` table migration
  - [ ] Add unique constraint on code
  - [ ] Seed with default types (labor, material, subcontract, equipment, other)
- [ ] Create `project_cost_codes` table migration
  - [ ] Add unique constraint on project_id + cost_code_id
  - [ ] Create indexes for performance
- [ ] Create `vertical_markup` table migration
  - [ ] Add unique constraint on project_id + markup_type
  - [ ] Add check constraint on percentage (0-100)
- [ ] Create `project_directory` table migration
  - [ ] Add unique constraint on project_id + company_id + role
  - [ ] Add role enum validation

**Existing Table Updates:**
- [ ] Update `projects` table
  - [ ] Add budget_locked column
  - [ ] Add budget_locked_at timestamp
  - [ ] Add budget_locked_by foreign key
- [ ] Update `prime_contracts` table
  - [ ] Add retention_percentage column
  - [ ] Add apply_vertical_markup column
- [ ] Update `commitments` table
  - [ ] Add retention_percentage column
- [ ] Update `change_orders` table
  - [ ] Add apply_vertical_markup column
- [ ] Update `budget_items` table
  - [ ] Add original_amount column
  - [ ] Add budget_modifications column
  - [ ] Add approved_cos column
  - [ ] Add revised_budget generated column
  - [ ] Add committed_cost column
  - [ ] Add direct_cost column
  - [ ] Add pending_cost_changes column
  - [ ] Add projected_cost generated column
  - [ ] Add forecast_to_complete generated column

**Post-Migration Tasks:**
- [ ] Run all migrations in test environment
- [ ] Regenerate database types
- [ ] Update TypeScript interfaces in frontend
- [ ] Create RLS policies for new tables
- [ ] Document schema changes in EXEC_PLAN.md
- [ ] Run integration tests

#### 1.1 Create Missing Tables

```sql
-- Schedule of Values main table
CREATE TABLE schedule_of_values (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  contract_id UUID REFERENCES prime_contracts(id),
  commitment_id UUID REFERENCES commitments(id),
  status TEXT DEFAULT 'draft', -- draft, pending_approval, approved, revised
  total_amount DECIMAL(15, 2),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  approved_at TIMESTAMP,
  approved_by UUID REFERENCES app_users(id),
  CONSTRAINT either_contract_or_commitment CHECK (
    (contract_id IS NOT NULL AND commitment_id IS NULL) OR
    (contract_id IS NULL AND commitment_id IS NOT NULL)
  )
);

-- SOV Line Items
CREATE TABLE sov_line_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sov_id UUID REFERENCES schedule_of_values(id) ON DELETE CASCADE,
  line_number INTEGER NOT NULL,
  description TEXT NOT NULL,
  cost_code_id UUID REFERENCES cost_codes(id),
  scheduled_value DECIMAL(15, 2) NOT NULL DEFAULT 0,
  percentage DECIMAL(5, 2) GENERATED ALWAYS AS (
    CASE 
      WHEN (SELECT total_amount FROM schedule_of_values WHERE id = sov_id) > 0 
      THEN (scheduled_value / (SELECT total_amount FROM schedule_of_values WHERE id = sov_id)) * 100
      ELSE 0
    END
  ) STORED,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Billing Periods
CREATE TABLE billing_periods (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id),
  period_number INTEGER NOT NULL,
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  status TEXT DEFAULT 'open', -- open, in_progress, closed
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Cost Code Types
CREATE TABLE cost_code_types (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT NOT NULL,
  description TEXT NOT NULL,
  category TEXT, -- labor, material, subcontract, equipment, other
  created_at TIMESTAMP DEFAULT NOW()
);

-- Project Cost Code Configuration
CREATE TABLE project_cost_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id),
  cost_code_id UUID REFERENCES cost_codes(id),
  cost_type_id UUID REFERENCES cost_code_types(id),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(project_id, cost_code_id)
);

-- Vertical Markup Settings
CREATE TABLE vertical_markup (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id),
  markup_type TEXT NOT NULL, -- insurance, bond, fee, overhead
  percentage DECIMAL(5, 2) NOT NULL,
  calculation_order INTEGER NOT NULL,
  compound BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Budget Lock Status
ALTER TABLE projects ADD COLUMN IF NOT EXISTS budget_locked BOOLEAN DEFAULT false;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS budget_locked_at TIMESTAMP;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS budget_locked_by UUID REFERENCES app_users(id);

-- Add retention settings to contracts
ALTER TABLE prime_contracts ADD COLUMN IF NOT EXISTS retention_percentage DECIMAL(5, 2) DEFAULT 0;
ALTER TABLE commitments ADD COLUMN IF NOT EXISTS retention_percentage DECIMAL(5, 2) DEFAULT 0;

-- Add vertical markup reference
ALTER TABLE prime_contracts ADD COLUMN IF NOT EXISTS apply_vertical_markup BOOLEAN DEFAULT true;
ALTER TABLE change_orders ADD COLUMN IF NOT EXISTS apply_vertical_markup BOOLEAN DEFAULT true;
```

#### 1.2 Update Existing Tables

```sql
-- Add missing fields to budget_items
ALTER TABLE budget_items ADD COLUMN IF NOT EXISTS original_amount DECIMAL(15, 2);
ALTER TABLE budget_items ADD COLUMN IF NOT EXISTS budget_modifications DECIMAL(15, 2) DEFAULT 0;
ALTER TABLE budget_items ADD COLUMN IF NOT EXISTS approved_cos DECIMAL(15, 2) DEFAULT 0;
ALTER TABLE budget_items ADD COLUMN IF NOT EXISTS revised_budget DECIMAL(15, 2) GENERATED ALWAYS AS (
  COALESCE(original_amount, 0) + COALESCE(budget_modifications, 0) + COALESCE(approved_cos, 0)
) STORED;
ALTER TABLE budget_items ADD COLUMN IF NOT EXISTS committed_cost DECIMAL(15, 2) DEFAULT 0;
ALTER TABLE budget_items ADD COLUMN IF NOT EXISTS direct_cost DECIMAL(15, 2) DEFAULT 0;
ALTER TABLE budget_items ADD COLUMN IF NOT EXISTS pending_cost_changes DECIMAL(15, 2) DEFAULT 0;
ALTER TABLE budget_items ADD COLUMN IF NOT EXISTS projected_cost DECIMAL(15, 2) GENERATED ALWAYS AS (
  COALESCE(committed_cost, 0) + COALESCE(direct_cost, 0) + COALESCE(pending_cost_changes, 0)
) STORED;
ALTER TABLE budget_items ADD COLUMN IF NOT EXISTS forecast_to_complete DECIMAL(15, 2) GENERATED ALWAYS AS (
  COALESCE(revised_budget, 0) - COALESCE(projected_cost, 0)
) STORED;

-- Add project directory relationships
CREATE TABLE project_directory (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id),
  company_id UUID REFERENCES companies(id),
  role TEXT NOT NULL, -- owner, architect, engineer, subcontractor, vendor
  is_active BOOLEAN DEFAULT true,
  permissions JSONB DEFAULT '{}', -- for SOV access, etc.
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(project_id, company_id, role)
);
```

### Phase 2: Project Setup Wizard (Week 1-2)

#### Phase 2 Detailed Checklist

**Pre-Phase 2 Requirements:**
- [ ] Ensure Phase 1 database migrations are complete
- [ ] Verify all new tables are accessible via Supabase client
- [ ] Create feature branch for project setup wizard
- [ ] Set up test project for development

**Component Development:**
- [ ] Create Project Setup Wizard base component
  - [ ] Create `frontend/src/components/project-setup/` directory
  - [ ] Build `ProjectSetupWizard.tsx` main component
  - [ ] Implement step navigation logic
  - [ ] Add progress indicator
  - [ ] Create step validation framework
  - [ ] Add skip/back functionality
  - [ ] Implement auto-save between steps

- [ ] Create Cost Code Setup component
  - [ ] Build `CostCodeSetup.tsx` component
  - [ ] Create cost code selection UI
  - [ ] Implement CSV import functionality
    - [ ] Add file upload component
    - [ ] Create CSV parser
    - [ ] Build column mapping interface
    - [ ] Add preview table
    - [ ] Implement validation errors display
  - [ ] Create template download functionality
  - [ ] Add bulk selection/deselection
  - [ ] Connect to `project_cost_codes` table
  - [ ] Test with 100+ cost codes

- [ ] Create Project Directory Setup component
  - [ ] Build `ProjectDirectorySetup.tsx` component
  - [ ] Create company search/selection UI
  - [ ] Implement role assignment interface
  - [ ] Add permission configuration
  - [ ] Build invite functionality
  - [ ] Connect to `project_directory` table
  - [ ] Add validation for required roles

- [ ] Create Document Upload Setup component
  - [ ] Build `DocumentUploadSetup.tsx` component
  - [ ] Create drag-and-drop upload area
  - [ ] Implement folder structure creation
  - [ ] Add document categorization
  - [ ] Build batch upload progress UI
  - [ ] Connect to Supabase Storage
  - [ ] Add file type validation

- [ ] Create Budget Setup component
  - [ ] Build `BudgetSetup.tsx` component
  - [ ] Create budget template selection
  - [ ] Implement Excel/CSV import
  - [ ] Build manual entry interface
  - [ ] Add cost code assignment
  - [ ] Create budget preview
  - [ ] Connect to `budget_items` table
  - [ ] Add validation totals

- [ ] Create Prime Contract Setup component
  - [ ] Build `PrimeContractSetup.tsx` component
  - [ ] Create contract form with all fields
  - [ ] Implement client selection
  - [ ] Add retention settings
  - [ ] Build SOV quick entry
  - [ ] Connect to `prime_contracts` table

**Integration Tasks:**
- [ ] Add setup wizard trigger after project creation
- [ ] Create setup completion tracking
- [ ] Implement setup resumption for incomplete wizards
- [ ] Add setup status to project list
- [ ] Create setup analytics/metrics
- [ ] Build help tooltips for each section

**Testing:**
- [ ] Unit tests for each component
- [ ] Integration test for full wizard flow
- [ ] Test data persistence between steps
- [ ] Test validation error handling
- [ ] Test file upload edge cases
- [ ] Load test with large datasets

#### 2.1 Create Project Setup Flow Components

```typescript
// frontend/src/components/project-setup/ProjectSetupWizard.tsx
interface ProjectSetupStep {
  id: string;
  title: string;
  description: string;
  component: React.ComponentType<ProjectSetupStepProps>;
  isComplete: boolean;
}

const setupSteps: ProjectSetupStep[] = [
  {
    id: 'cost-codes',
    title: 'Configure Cost Codes',
    description: 'Import or select cost codes for your project',
    component: CostCodeSetup,
    isComplete: false
  },
  {
    id: 'directory',
    title: 'Project Directory',
    description: 'Add team members, subs, and vendors',
    component: ProjectDirectorySetup,
    isComplete: false
  },
  {
    id: 'documents',
    title: 'Upload Documents',
    description: 'Add drawings, specs, and contracts',
    component: DocumentUploadSetup,
    isComplete: false
  },
  {
    id: 'budget',
    title: 'Initial Budget',
    description: 'Set up your project budget',
    component: BudgetSetup,
    isComplete: false
  },
  {
    id: 'prime-contract',
    title: 'Prime Contract',
    description: 'Create your primary contract',
    component: PrimeContractSetup,
    isComplete: false
  }
];
```

#### 2.2 Cost Code Import/Export

```typescript
// frontend/src/components/cost-codes/CostCodeImport.tsx
- CSV/Excel import functionality
- Template download
- Mapping interface for columns
- Preview before import
- Bulk operations support
```

#### 2.3 Budget Import Template

```typescript
// frontend/src/lib/templates/budget-import.ts
interface BudgetImportRow {
  costCode: string;
  description: string;
  quantity: number;
  unit: string;
  unitCost: number;
  totalCost: number;
  costType: string; // labor, material, subcontract, equipment, other
}
```

### Phase 3: Enhanced Contract Management (Week 2-3)

#### Phase 3 Detailed Checklist

**Pre-Phase 3 Requirements:**
- [ ] Complete Phase 2 project setup wizard
- [ ] Ensure SOV tables are properly configured
- [ ] Review existing contract forms for enhancement points
- [ ] Create mockups for new contract tabs

**Contract Form Enhancements:**
- [ ] Refactor Contract Form Structure
  - [ ] Create tabbed interface component
  - [ ] Implement tab navigation with validation
  - [ ] Add unsaved changes warning
  - [ ] Create tab completion indicators
  - [ ] Add progress saving between tabs

- [ ] General Information Tab
  - [ ] Update existing general info fields
  - [ ] Add contract template selection
  - [ ] Implement auto-numbering system
  - [ ] Add contract type selection
  - [ ] Create duplicate contract functionality

- [ ] Schedule of Values Tab
  - [ ] Integrate existing `ScheduleOfValuesGrid` component
  - [ ] Add "Import from Budget" functionality
    - [ ] Create budget line item selector
    - [ ] Build import preview
    - [ ] Add percentage allocation
    - [ ] Implement overwrite warnings
  - [ ] Create SOV template system
  - [ ] Add line item cost code validation
  - [ ] Implement auto-calculation of percentages
  - [ ] Add SOV approval workflow UI
  - [ ] Create SOV revision tracking

- [ ] Retention Settings Tab
  - [ ] Build retention configuration form
  - [ ] Add percentage input with validation (0-100%)
  - [ ] Create retention release schedule
  - [ ] Add conditional retention rules
  - [ ] Implement retention calculation preview

- [ ] Vertical Markup Tab
  - [ ] Create markup configuration interface
  - [ ] Add markup type selector (insurance, bond, fee, etc.)
  - [ ] Implement percentage inputs
  - [ ] Create compound calculation toggle
  - [ ] Build calculation order drag-and-drop
  - [ ] Add real-time calculation preview
  - [ ] Connect to `vertical_markup` table

- [ ] Documents Tab
  - [ ] Create document upload section
  - [ ] Add document categorization
  - [ ] Implement version control
  - [ ] Add document approval workflow
  - [ ] Create document template library

- [ ] Advanced Settings Tab
  - [ ] Add payment terms configuration
  - [ ] Create milestone payment setup
  - [ ] Add insurance requirements
  - [ ] Implement custom fields
  - [ ] Add integration settings

**Contract Details Page:**
- [ ] Create comprehensive contract details view
  - [ ] Build `/contracts/[id]` page structure
  - [ ] Implement tab navigation matching form
  - [ ] Add contract actions toolbar
  - [ ] Create contract status workflow
  - [ ] Add activity timeline

- [ ] Financial Summary Section
  - [ ] Display original contract value
  - [ ] Show approved change orders
  - [ ] Calculate revised contract value
  - [ ] Add payment summary
  - [ ] Show retention held/released

- [ ] Related Items Section
  - [ ] List associated change orders
  - [ ] Show related commitments
  - [ ] Display payment applications
  - [ ] Add related documents

**Testing:**
- [ ] Test all tab validations
- [ ] Verify calculation accuracy
- [ ] Test import functionality
- [ ] Validate compound markup calculations
- [ ] Test document upload limits
- [ ] Verify data persistence

#### 3.1 Prime Contract Form Enhancement

```typescript
// frontend/src/app/contract-form/ContractFormTabs.tsx
const contractTabs = [
  { id: 'general', label: 'General Information' },
  { id: 'sov', label: 'Schedule of Values' },
  { id: 'retention', label: 'Retention Settings' },
  { id: 'markup', label: 'Vertical Markup' },
  { id: 'documents', label: 'Documents' },
  { id: 'advanced', label: 'Advanced Settings' }
];
```

#### 3.2 Schedule of Values Integration

```typescript
// frontend/src/components/contracts/ScheduleOfValuesTab.tsx
- Integrate existing ScheduleOfValuesGrid
- Add import from budget functionality
- Enable line item cost code assignment
- Calculate percentages automatically
- Add approval workflow UI
```

#### 3.3 Vertical Markup Configuration

```typescript
// frontend/src/components/contracts/VerticalMarkupTab.tsx
interface VerticalMarkupItem {
  type: 'insurance' | 'bond' | 'fee' | 'overhead' | 'custom';
  percentage: number;
  compound: boolean;
  order: number;
}

// Calculation engine for compound markup
function calculateWithMarkup(baseCost: number, markups: VerticalMarkupItem[]): number {
  return markups.reduce((cost, markup) => {
    const markupAmount = cost * (markup.percentage / 100);
    return markup.compound ? cost + markupAmount : baseCost + markupAmount;
  }, baseCost);
}
```

### Phase 4: Budget Management Enhancements (Week 3)

#### Phase 4 Detailed Checklist

**Pre-Phase 4 Requirements:**
- [ ] Ensure budget_items table has all new columns
- [ ] Complete contract management features
- [ ] Review existing budget page functionality
- [ ] Create budget workflow documentation

**Budget Locking Feature:**
- [ ] Create Budget Lock Component
  - [ ] Build `BudgetLockButton.tsx` component
  - [ ] Add lock/unlock toggle with icon states
  - [ ] Create confirmation dialog
    - [ ] Add warning message about implications
    - [ ] Require reason for locking/unlocking
    - [ ] Show affected users count
  - [ ] Implement permission checks
    - [ ] Check user role permissions
    - [ ] Validate project ownership
    - [ ] Add admin override capability
  - [ ] Add audit trail logging
    - [ ] Log who locked/unlocked
    - [ ] Record timestamp
    - [ ] Save reason provided
  - [ ] Update UI to show locked state
    - [ ] Disable edit buttons
    - [ ] Show lock indicator
    - [ ] Display who locked and when

**Budget Modifications System:**
- [ ] Create Budget Modifications Page
  - [ ] Build `/budget-modifications/page.tsx`
  - [ ] Create modification list view
  - [ ] Add filters by date, user, type
  - [ ] Implement modification detail view

- [ ] Build Modification Creation Flow
  - [ ] Create "Transfer Funds" dialog
  - [ ] Add source line item selector
  - [ ] Add destination line item selector
  - [ ] Implement amount input with validation
  - [ ] Add reason/justification field
  - [ ] Create approval workflow
    - [ ] Add approval routing rules
    - [ ] Create approval notifications
    - [ ] Build approval queue view

- [ ] Update Budget Display
  - [ ] Add "Original Budget" column
  - [ ] Add "Modifications" column
  - [ ] Show "Revised Budget" calculation
  - [ ] Add modification indicators
  - [ ] Create modification history modal

**Budget Import/Export:**
- [ ] Create Import Functionality
  - [ ] Build import dialog component
  - [ ] Add template download button
  - [ ] Create file upload with drag-drop
  - [ ] Build column mapping interface
    - [ ] Auto-detect column headers
    - [ ] Allow manual mapping
    - [ ] Save mapping preferences
  - [ ] Add preview with validation
    - [ ] Show errors and warnings
    - [ ] Allow fixing before import
    - [ ] Display summary statistics
  - [ ] Implement import processing
    - [ ] Handle large files (1000+ rows)
    - [ ] Add progress indicator
    - [ ] Create import history log

- [ ] Create Export Functionality
  - [ ] Add export button to toolbar
  - [ ] Create format selection (Excel, CSV, PDF)
  - [ ] Add column selection options
  - [ ] Include metadata in export
  - [ ] Add date range filters

**Forecast Management:**
- [ ] Enhanced Forecast Features
  - [ ] Create editable forecast column
  - [ ] Add forecast override capability
  - [ ] Implement forecast history tracking
  - [ ] Create forecast variance alerts
  - [ ] Add forecast approval workflow

- [ ] Forecast Analytics
  - [ ] Create forecast accuracy metrics
  - [ ] Add trend analysis charts
  - [ ] Build forecast vs actual reports
  - [ ] Add predictive forecasting

**Financial Calculations Engine:**
- [ ] Implement Complex Calculations
  - [ ] Create calculation service
  - [ ] Add calculation caching
  - [ ] Implement real-time updates
  - [ ] Add calculation audit trail
  - [ ] Create calculation documentation

- [ ] Calculation Features
  - [ ] Original + Modifications + COs = Revised Budget
  - [ ] Committed + Direct + Pending = Projected Cost
  - [ ] Revised Budget - Projected Cost = Forecast
  - [ ] Add custom calculation rules
  - [ ] Create calculation templates

**Testing:**
- [ ] Test budget locking permissions
- [ ] Verify modification calculations
- [ ] Test import with various file formats
- [ ] Validate export data accuracy
- [ ] Load test with large budgets
- [ ] Test calculation performance

#### 4.1 Budget Locking Mechanism

```typescript
// frontend/src/components/budget/BudgetLockButton.tsx
- Lock/unlock budget functionality
- Confirmation dialog
- Permission checks
- Audit trail logging
```

#### 4.2 Budget Modifications

```typescript
// frontend/src/app/budget-modifications/page.tsx
interface BudgetModification {
  fromLineItem: string;
  toLineItem: string;
  amount: number;
  reason: string;
  approvedBy: string;
  approvedAt: Date;
}
```

#### 4.3 Forecast Management

```typescript
// frontend/src/components/budget/ForecastColumn.tsx
- Editable forecast to complete
- Automatic calculation toggle
- Variance highlighting
- Over/under indicators
```

### Phase 5: Commitment Enhancements (Week 3-4)

#### Phase 5 Detailed Checklist

**Pre-Phase 5 Requirements:**
- [ ] Complete budget management enhancements
- [ ] Ensure SOV tables are fully functional
- [ ] Review existing commitment forms
- [ ] Set up subcontractor test accounts

**Subcontractor Portal Development:**
- [ ] Create Subcontractor Portal Structure
  - [ ] Build portal layout component
  - [ ] Create role-based navigation
  - [ ] Add portal dashboard
  - [ ] Implement permission boundaries
  - [ ] Add portal branding options

- [ ] SOV Submission Interface
  - [ ] Create `/subcontractor-portal/sov/page.tsx`
  - [ ] Build SOV list view for subcontractors
    - [ ] Show only their contracts
    - [ ] Display SOV status clearly
    - [ ] Add submission deadlines
  - [ ] Create SOV entry form
    - [ ] Pre-populate contract information
    - [ ] Add line item entry interface
    - [ ] Implement running total calculator
    - [ ] Add percentage validation
  - [ ] Build submission workflow
    - [ ] Add draft saving
    - [ ] Create preview before submit
    - [ ] Implement submission confirmation
    - [ ] Send notification to GC

- [ ] SOV Review Process
  - [ ] Create review queue for GC
  - [ ] Build comparison view (submitted vs expected)
  - [ ] Add comment/feedback system
  - [ ] Create revision request workflow
  - [ ] Implement approval process

- [ ] Portal Features
  - [ ] Add document upload for SOV backup
  - [ ] Create submission history
  - [ ] Add print/export functionality
  - [ ] Build help documentation
  - [ ] Implement email notifications

**Commitment Form Enhancements:**
- [ ] Update Subcontract Form
  - [ ] Add SOV configuration section
  - [ ] Create retention settings
  - [ ] Add insurance requirements
  - [ ] Implement scope definition
    - [ ] Rich text editor for inclusions
    - [ ] Structured exclusions list
    - [ ] Add clarifications section
  - [ ] Create approval workflow settings

- [ ] Purchase Order Enhancements
  - [ ] Add line item detail expansion
  - [ ] Create delivery schedule
  - [ ] Add inspection requirements
  - [ ] Implement change order allowance
  - [ ] Add terms and conditions

- [ ] Commitment Details Page
  - [ ] Create comprehensive view like contracts
  - [ ] Add SOV tracking section
  - [ ] Show payment history
  - [ ] Display change order log
  - [ ] Add performance metrics

**Contract Document Generation:**
- [ ] PDF Generation System
  - [ ] Create PDF template engine
  - [ ] Build contract PDF generator
    - [ ] Add company letterhead
    - [ ] Include all contract sections
    - [ ] Add signature blocks
    - [ ] Include exhibits/attachments
  - [ ] Create PO PDF generator
  - [ ] Add batch generation capability

- [ ] Document Features
  - [ ] Add watermarking for drafts
  - [ ] Create version tracking
  - [ ] Implement digital signatures
  - [ ] Add document merge capability
  - [ ] Create document templates library

**Integration Features:**
- [ ] Email Integration
  - [ ] Create email templates
  - [ ] Add automated notifications
  - [ ] Build email tracking
  - [ ] Implement reminder system

- [ ] Reporting
  - [ ] Create commitment summary reports
  - [ ] Add SOV status dashboard
  - [ ] Build payment tracking reports
  - [ ] Add vendor performance metrics

**Testing:**
- [ ] Test subcontractor portal permissions
- [ ] Verify SOV calculations
- [ ] Test PDF generation accuracy
- [ ] Validate email notifications
- [ ] Test with multiple subcontractors
- [ ] Performance test portal

#### 5.1 Subcontractor SOV Portal

```typescript
// frontend/src/app/subcontractor-portal/sov/page.tsx
- Subcontractor-specific view
- SOV submission interface
- Status tracking
- Notification system
```

#### 4.2 Contract Document Generation

```typescript
// frontend/src/lib/pdf/contract-generator.ts
- PDF generation with dynamic data
- Include scope, exclusions, terms
- Signature placeholders
- Document versioning
```

### Phase 6: Financial Workflows (Week 4)

#### Phase 6 Detailed Checklist

**Pre-Phase 6 Requirements:**
- [ ] Complete all commitment enhancements
- [ ] Ensure billing periods table is set up
- [ ] Review existing invoice functionality
- [ ] Create test data for financial workflows

**Payment Application System:**
- [ ] Create Payment Application Structure
  - [ ] Build `/payment-applications/page.tsx`
  - [ ] Create application list view
  - [ ] Add filters by period, status, contractor
  - [ ] Implement application creation flow

- [ ] Application Creation Workflow
  - [ ] Create billing period selector
  - [ ] Build SOV-based application form
    - [ ] Load approved SOV line items
    - [ ] Add previous period data
    - [ ] Calculate period percentages
    - [ ] Auto-calculate totals
  - [ ] Add work completed inputs
    - [ ] Previous completed amount
    - [ ] Current period amount
    - [ ] Total completed to date
    - [ ] Percentage complete
  - [ ] Implement materials stored
    - [ ] Add stored materials section
    - [ ] Calculate stored percentages
    - [ ] Track material usage

- [ ] Retention Calculations
  - [ ] Apply retention percentage
  - [ ] Calculate retention held
  - [ ] Track retention released
  - [ ] Show net payment due

- [ ] Application Review Process
  - [ ] Create review interface
  - [ ] Add approval workflow
  - [ ] Implement rejection reasons
  - [ ] Create revision tracking
  - [ ] Add comment threads

**Invoice Management Enhancement:**
- [ ] Update Invoice Creation
  - [ ] Link to payment applications
  - [ ] Auto-generate from applications
  - [ ] Add manual invoice option
  - [ ] Create invoice templates

- [ ] Invoice Processing
  - [ ] Add approval workflow
  - [ ] Create payment tracking
  - [ ] Implement aging reports
  - [ ] Add dispute management

**Financial Reporting:**
- [ ] Budget vs Actual Reports
  - [ ] Create report generator
  - [ ] Add date range selection
  - [ ] Implement grouping options
  - [ ] Add drill-down capability
  - [ ] Create export formats

- [ ] Cash Flow Analysis
  - [ ] Build cash flow projections
  - [ ] Add payment schedules
  - [ ] Create receivables tracking
  - [ ] Implement payables tracking

- [ ] Executive Dashboard
  - [ ] Create financial KPIs
  - [ ] Add trend charts
  - [ ] Build project comparisons
  - [ ] Implement alerts/warnings

**Integration Features:**
- [ ] Accounting System Integration
  - [ ] Create export mappings
  - [ ] Build sync functionality
  - [ ] Add validation rules
  - [ ] Implement error handling

- [ ] Banking Integration
  - [ ] Add ACH payment support
  - [ ] Create payment confirmations
  - [ ] Track payment status
  - [ ] Implement reconciliation

**Audit and Compliance:**
- [ ] Audit Trail
  - [ ] Log all financial changes
  - [ ] Track approvals
  - [ ] Record modifications
  - [ ] Create audit reports

- [ ] Compliance Features
  - [ ] Add lien waiver tracking
  - [ ] Create certified payroll
  - [ ] Implement prevailing wage
  - [ ] Add compliance alerts

**Testing:**
- [ ] Test payment calculations
- [ ] Verify retention accuracy
- [ ] Test approval workflows
- [ ] Validate report data
- [ ] Test integration points
- [ ] Load test with large datasets

#### 6.1 Payment Applications

```typescript
// frontend/src/app/payment-applications/page.tsx
- Create applications from SOV
- Progress tracking
- Retention calculations
- Approval workflow
```

#### 6.2 Budget vs Actual Reporting

```typescript
// frontend/src/components/reports/BudgetVsActual.tsx
- Real-time calculations
- Drill-down capabilities
- Export functionality
- Trend analysis
```

## Testing Strategy

### 1. Unit Tests
- Database schema validation
- Calculation engines
- Form validations
- Component functionality

### 2. Integration Tests
- Full workflow testing
- API endpoint testing
- Database transaction testing
- Permission testing

### 3. E2E Tests (Playwright)
```typescript
// frontend/tests/e2e/project-setup-workflow.spec.ts
test.describe('Project Setup Workflow', () => {
  test('should complete full project setup', async ({ page }) => {
    // Create project
    // Configure cost codes
    // Add team members
    // Upload documents
    // Create budget
    // Create prime contract
    // Verify all data persisted
  });
});
```

## Migration Strategy

### 1. Data Migration
- Backup existing data
- Run schema migrations
- Populate new fields with defaults
- Update relationships

### 2. Feature Rollout
- Phase 1: Schema updates (no user impact)
- Phase 2: New pages (opt-in)
- Phase 3: Enhanced existing pages (gradual rollout)
- Phase 4: Deprecate old functionality

## Performance Considerations

### 1. Database Optimizations
- Indexes on frequently queried fields
- Materialized views for complex calculations
- Batch operations for imports

### 2. Frontend Optimizations
- Lazy loading for large datasets
- Virtual scrolling for tables
- Debounced calculations
- Optimistic UI updates

## Security Considerations

### 1. Row Level Security
- Project-based access control
- Role-based permissions
- Subcontractor data isolation

### 2. Audit Trail
- Track all financial modifications
- Log budget lock/unlock events
- Record approval workflows

## Master Implementation Checklist Summary

### Phase Progress Tracking
- [ ] **Phase 1: Database Schema Updates** (Week 1)
  - [ ] Pre-requirements completed (4 items)
  - [ ] Database tables created (7 tables)
  - [ ] Existing tables updated (5 tables)
  - [ ] Post-migration tasks completed (6 items)
  - **Total Phase 1 Items: 70+ checkboxes**

- [ ] **Phase 2: Project Setup Wizard** (Week 1-2)
  - [ ] Pre-requirements completed (4 items)
  - [ ] Components developed (6 major components)
  - [ ] Integration tasks completed (6 items)
  - [ ] Testing completed (6 test suites)
  - **Total Phase 2 Items: 50+ checkboxes**

- [ ] **Phase 3: Enhanced Contract Management** (Week 2-3)
  - [ ] Pre-requirements completed (4 items)
  - [ ] Contract form enhanced (7 tabs)
  - [ ] Contract details page created
  - [ ] Testing completed (6 test categories)
  - **Total Phase 3 Items: 60+ checkboxes**

- [ ] **Phase 4: Budget Management Enhancements** (Week 3)
  - [ ] Pre-requirements completed (4 items)
  - [ ] Budget locking implemented
  - [ ] Modifications system created
  - [ ] Import/Export functionality built
  - [ ] Forecast management implemented
  - [ ] Testing completed (6 test areas)
  - **Total Phase 4 Items: 75+ checkboxes**

- [ ] **Phase 5: Commitment Enhancements** (Week 3-4)
  - [ ] Pre-requirements completed (4 items)
  - [ ] Subcontractor portal developed
  - [ ] Commitment forms enhanced
  - [ ] Document generation built
  - [ ] Integration features added
  - [ ] Testing completed (6 test types)
  - **Total Phase 5 Items: 65+ checkboxes**

- [ ] **Phase 6: Financial Workflows** (Week 4)
  - [ ] Pre-requirements completed (4 items)
  - [ ] Payment applications created
  - [ ] Invoice management enhanced
  - [ ] Financial reporting built
  - [ ] Integration features added
  - [ ] Audit/compliance implemented
  - [ ] Testing completed (6 test areas)
  - **Total Phase 6 Items: 80+ checkboxes**

### Overall Progress Metrics
- **Total Implementation Items: 400+ checkboxes**
- **Estimated Development Hours: 800-1000 hours**
- **Team Size Recommendation: 3-4 developers**

## Timeline Summary

- **Week 1**: Database schema updates, start project setup wizard
- **Week 2**: Complete project setup wizard, enhance contract forms
- **Week 3**: Budget management features, commitment enhancements
- **Week 4**: Financial workflows, testing, and deployment preparation
- **Week 5**: Buffer for testing, bug fixes, and deployment

## Success Metrics

1. **Functional Completeness**: All video walkthrough features implemented
2. **Performance**: Page load times < 2 seconds, calculations < 500ms
3. **User Adoption**: 90% of projects use new setup wizard
4. **Data Integrity**: Zero financial calculation errors
5. **User Satisfaction**: Positive feedback on workflow improvements

## Implementation Best Practices

1. **Daily Checklist Review**: Review phase checklists each morning
2. **Progress Tracking**: Update checkboxes as tasks complete
3. **Blocker Documentation**: Document any blockers immediately
4. **Testing as You Go**: Don't wait until phase end to test
5. **Code Reviews**: Every PR should reference checklist items
6. **Documentation**: Update docs as features are built

## Risk Mitigation

1. **Database Migrations**: Always test in staging first
2. **Breaking Changes**: Use feature flags for gradual rollout
3. **Performance**: Monitor query performance from day 1
4. **Security**: Review all RLS policies before deployment
5. **User Impact**: Communicate changes well in advance

## Next Steps

1. Review and approve implementation plan with detailed checklists
2. Assign team members to specific phases
3. Set up project tracking with checklist items
4. Create development and staging environments
5. Schedule daily standup meetings for progress review
6. Begin Phase 1 implementation

---

This enhanced implementation plan with detailed checklists provides a comprehensive, actionable roadmap for achieving the functionality demonstrated in the Procore walkthrough video. Each phase now has specific, measurable tasks that can be tracked and verified for completion.