# Generic Table Factory Guide

## Overview

This guide documents the ultra-streamlined generic table factory system for creating Supabase table pages. This system allows you to create fully-functional, production-ready table pages with just a configuration object.

## Benefits

✅ **Zero Boilerplate** - No need to write repetitive table components
✅ **Type-Safe** - Automatically inferred from Supabase database types
✅ **Consistent UI** - All pages use the same proven components
✅ **Feature-Rich** - Search, filters, column toggle, export built-in
✅ **Easy to Maintain** - Change once in the factory, update everywhere
✅ **Fast Development** - Create a new page in under 5 minutes

## Architecture

```text
┌─────────────────────────────────────────────────────┐
│  GenericDataTable Component                         │
│  (frontend/src/components/tables/generic-table-     │
│   factory.tsx)                                       │
│  - Handles all table rendering logic                │
│  - Manages search, filters, column visibility       │
│  - Provides export functionality                    │
│  - Type-safe with TypeScript                        │
└─────────────────────────────────────────────────────┘
                        ▲
                        │
                        │ Uses
                        │
┌─────────────────────────────────────────────────────┐
│  Page Component                                      │
│  (e.g., /app/(project-mgmt)/risks/page.tsx)         │
│  - Fetches data from Supabase (server-side)         │
│  - Defines table configuration                      │
│  - Passes data + config to GenericDataTable         │
└─────────────────────────────────────────────────────┘
                        ▲
                        │
                        │ Reads from
                        │
┌─────────────────────────────────────────────────────┐
│  Supabase Database                                   │
│  - Auto-generated types from schema                 │
│  - Type-safe queries                                │
└─────────────────────────────────────────────────────┘
```

## Created Pages

The following pages have been created using the generic table factory:

1. **Risks** - `/risks` - Track and manage project risks
2. **Opportunities** - `/opportunities` - Track business opportunities
3. **Decisions** - `/decisions` - Track important decisions
4. **Daily Logs** - `/daily-logs` - View daily construction logs
5. **Daily Recaps** - `/daily-recaps` - AI-generated daily summaries
6. **Issues** - `/issues` - Track and manage project issues
7. **Meeting Segments** - `/meeting-segments` - Chunked meeting content for AI
8. **Notes** - `/notes` - Project notes and annotations
9. **AI Insights** - `/insights` - AI-generated insights from meetings

## How to Create a New Table Page

### Step 1: Check Database Types

First, ensure your table exists in the Supabase database types:

```bash
cd frontend
grep "your_table_name: {" src/types/database.ts
```

### Step 2: Create the Page File

Create a new file at `frontend/src/app/(project-mgmt)/[your-table-name]/page.tsx`:

```tsx
import { createClient } from '@/lib/supabase/server'
import { GenericDataTable, type GenericTableConfig } from '@/components/tables/generic-table-factory'
import { Database } from '@/types/database.types'
import { Badge } from '@/components/ui/badge'

type YourEntity = Database['public']['Tables']['your_table_name']['Row']

const config: GenericTableConfig = {
  title: 'Your Title',
  description: 'Description of what this page shows',
  searchFields: ['field1', 'field2', 'field3'], // Fields to search across
  exportFilename: 'your-entity-export.csv',
  columns: [
    {
      id: 'field_name',
      label: 'Display Name',
      defaultVisible: true,
      type: 'text', // 'text' | 'date' | 'badge' | 'number' | 'email'
    },
    // Add more columns...
  ],
  filters: [ // Optional
    {
      id: 'status',
      label: 'Status',
      field: 'status',
      options: [
        { value: 'open', label: 'Open' },
        { value: 'closed', label: 'Closed' },
      ],
    },
  ],
  rowClickPath: (row) => `/your-path/${row.id}`,
}

export default async function YourEntityPage() {
  const supabase = await createClient()

  const { data, error } = await supabase
    .from('your_table_name')
    .select('*')
    .order('created_at', { ascending: false })

  if (error) {
    console.error('Error fetching data:', error)
    return (
      <div className="container mx-auto py-10">
        <div className="text-center text-red-600">
          Error loading data. Please try again later.
        </div>
      </div>
    )
  }

  return (
    <div className="container mx-auto py-10">
      <GenericDataTable data={data || []} config={config} />
    </div>
  )
}
```

### Step 3: Configure Columns

The `columns` array defines which database fields to display and how to display them:

#### Basic Text Column
```tsx
{
  id: 'name',
  label: 'Name',
  defaultVisible: true,
  type: 'text',
}
```

#### Date Column
```tsx
{
  id: 'created_at',
  label: 'Created',
  defaultVisible: true,
  type: 'date',
}
```

#### Badge Column (Status)
```tsx
{
  id: 'status',
  label: 'Status',
  defaultVisible: true,
  render: (value) => {
    const status = value as string
    const variant = status === 'open' ? 'destructive' : 'default'
    return <Badge variant={variant}>{status}</Badge>
  },
}
```

#### Number/Currency Column
```tsx
{
  id: 'total_cost',
  label: 'Total Cost',
  defaultVisible: true,
  render: (value) => {
    return value ? `$${Number(value).toLocaleString()}` : 'N/A'
  },
}
```

#### Email Column
```tsx
{
  id: 'email',
  label: 'Email',
  defaultVisible: true,
  type: 'email',
}
```

#### Custom Render Function
```tsx
{
  id: 'description',
  label: 'Description',
  defaultVisible: true,
  render: (value) => {
    const text = value as string
    return text ? text.substring(0, 100) + '...' : 'N/A'
  },
}
```

### Step 4: Configure Filters (Optional)

Add dropdown filters for common fields:

```tsx
filters: [
  {
    id: 'status',
    label: 'Status',
    field: 'status',
    options: [
      { value: 'open', label: 'Open' },
      { value: 'in_progress', label: 'In Progress' },
      { value: 'closed', label: 'Closed' },
    ],
  },
  {
    id: 'priority',
    label: 'Priority',
    field: 'priority',
    options: [
      { value: 'high', label: 'High' },
      { value: 'medium', label: 'Medium' },
      { value: 'low', label: 'Low' },
    ],
  },
],
```

### Step 5: Test the Page

Run the E2E tests:

```bash
cd frontend
BASE_URL=http://localhost:3002 npx playwright test tests/e2e/generic-table-pages.spec.ts
```

## Configuration Reference

### GenericTableConfig

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `title` | string | Yes | Page title (displayed in H2) |
| `description` | string | Yes | Page description (displayed below title) |
| `searchFields` | string[] | Yes | Array of field names to search across |
| `exportFilename` | string | No | Filename for CSV export (default: 'export.csv') |
| `columns` | ColumnConfig[] | Yes | Array of column configurations |
| `filters` | FilterConfig[] | No | Array of filter configurations |
| `rowClickPath` | (row) => string | No | Function returning URL for row click navigation |

### ColumnConfig

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `id` | string | Yes | Database field name |
| `label` | string | Yes | Display label for column header |
| `defaultVisible` | boolean | Yes | Whether column is visible by default |
| `type` | 'text' \| 'date' \| 'badge' \| 'number' \| 'email' | No | Built-in render type |
| `render` | (value, row) => ReactNode | No | Custom render function (overrides type) |

### FilterConfig

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `id` | string | Yes | Unique filter identifier |
| `label` | string | Yes | Display label for filter dropdown |
| `field` | string | Yes | Database field to filter on |
| `options` | {value: string, label: string}[] | Yes | Filter option values and labels |

## Built-in Features

Every table page created with the factory includes:

### Search
- Full-text search across all `searchFields`
- Real-time filtering as you type
- Case-insensitive matching

### Filters
- Dropdown filters for categorical data
- Multiple filters can be active simultaneously
- "All" option automatically added

### Column Toggle
- Show/hide columns dynamically
- State persists during session
- Dropdown checklist interface

### Export
- Export visible data to CSV
- Respects current filters and search
- Only exports visible columns
- Custom filename support

### Responsive Design
- Mobile-friendly layout
- Touch-friendly controls
- Responsive table scrolling

### Row Navigation
- Optional click-to-navigate
- Cursor pointer on hover
- Row highlight on hover

## Badge Variants

The `Badge` component supports these variants for status indicators:

- `default` - Blue/neutral
- `destructive` - Red/error
- `outline` - Gray outline
- `secondary` - Gray filled

Example usage:

```tsx
render: (value) => {
  const status = value as string
  const variant =
    status === 'critical' ? 'destructive' :
    status === 'high' ? 'default' :
    'outline'
  return <Badge variant={variant}>{status}</Badge>
}
```

## Testing

All pages are automatically tested with comprehensive E2E tests:

```bash
# Run all generic table page tests
cd frontend
BASE_URL=http://localhost:3002 npx playwright test tests/e2e/generic-table-pages.spec.ts

# Run tests for specific page
BASE_URL=http://localhost:3002 npx playwright test tests/e2e/generic-table-pages.spec.ts -g "Risks"

# Run with UI
BASE_URL=http://localhost:3002 npx playwright test tests/e2e/generic-table-pages.spec.ts --ui
```

Tests verify:
- Page loads without errors
- Heading displays correctly
- Search input is visible
- Export button is visible
- Column toggle is visible
- Table renders
- Record count displays
- Search functionality works
- Column toggle works

Screenshots are automatically captured in `frontend/tests/screenshots/generic-tables/`.

## Advanced Customization

### Custom Cell Rendering

For complex cell content:

```tsx
{
  id: 'metadata',
  label: 'Metadata',
  defaultVisible: true,
  render: (value, row) => {
    const meta = value as Record<string, unknown>
    return (
      <div className="flex flex-col">
        <span className="font-medium">{meta.title}</span>
        <span className="text-sm text-muted-foreground">
          {meta.subtitle}
        </span>
      </div>
    )
  },
}
```

### Multiple Badge Values

```tsx
{
  id: 'tags',
  label: 'Tags',
  defaultVisible: true,
  render: (value) => {
    const tags = value as string[]
    return (
      <div className="flex gap-1 flex-wrap">
        {tags?.map(tag => (
          <Badge key={tag} variant="outline" className="text-xs">
            {tag}
          </Badge>
        ))}
      </div>
    )
  },
}
```

### Conditional Formatting

```tsx
{
  id: 'amount',
  label: 'Amount',
  defaultVisible: true,
  render: (value) => {
    const amount = Number(value)
    const isNegative = amount < 0
    return (
      <span className={isNegative ? 'text-red-600' : 'text-green-600'}>
        ${Math.abs(amount).toLocaleString()}
      </span>
    )
  },
}
```

## Best Practices

1. **Always use server-side data fetching** - Pages should be server components
2. **Add proper error handling** - Always check for Supabase errors
3. **Order by created_at desc** - Show newest records first by default
4. **Keep searchFields relevant** - Only include fields users would search
5. **Use defaultVisible wisely** - Show 5-8 columns by default, hide the rest
6. **Provide meaningful labels** - Use human-friendly column names
7. **Use type-safe Badge variants** - Stick to the defined variant types
8. **Test export functionality** - Ensure CSV exports work with your data
9. **Add filters for categories** - Status, priority, type fields work well
10. **Use custom render for JSON** - Don't display raw JSON in tables

## Troubleshooting

### "Table does not exist" error
- Run schema validation: `cd backend && ./scripts/check_schema.sh`
- Regenerate types: `cd frontend && npm run db:types`

### Columns not displaying
- Check `defaultVisible` is set correctly
- Verify field name matches database column exactly
- Check for typos in column `id` field

### Search not working
- Ensure `searchFields` contains valid column names
- Check that columns exist in database types
- Verify data is actually loaded (check Network tab)

### Filters not working
- Ensure `field` in FilterConfig matches database column
- Check that `value` in options matches actual database values
- Verify filter dropdown is visible and clickable

### Type errors
- Regenerate database types after schema changes
- Import types from `@/types/database.types`
- Use type assertions when needed (e.g., `value as string`)

## Examples

See the following files for complete examples:

- [Risks Page](../frontend/src/app/(project-mgmt)/risks/page.tsx)
- [Opportunities Page](../frontend/src/app/(project-mgmt)/opportunities/page.tsx)
- [Decisions Page](../frontend/src/app/(project-mgmt)/decisions/page.tsx)
- [Issues Page](../frontend/src/app/(project-mgmt)/issues/page.tsx)
- [AI Insights Page](../frontend/src/app/(project-mgmt)/insights/page.tsx)

## Summary

The generic table factory allows you to:

1. **Create a new table page in under 5 minutes**
2. **Maintain consistency across all table pages**
3. **Get search, filters, export, and column toggle for free**
4. **Focus on configuration, not implementation**
5. **Leverage TypeScript for type safety**

This system is perfect for rapidly building out CRUD pages for Supabase tables while maintaining a professional, consistent UI throughout the application.

---

**Last Updated**: 2025-12-16
**Version**: 1.0
